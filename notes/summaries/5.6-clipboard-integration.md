# Summary: Section 5.6 - Clipboard Integration

## Implementation Overview

Implemented clipboard integration for TermUI applications with OSC 52 clipboard writing, bracketed paste handling, and selection management.

## Key Components

### Clipboard Module

```elixir
# Enable bracketed paste mode
IO.write(Clipboard.bracketed_paste_on())

# Write to system clipboard via OSC 52
Clipboard.write("content to copy")

# Get escape sequence for clipboard write
sequence = Clipboard.write_sequence("content", target: :clipboard)

# Check if OSC 52 is likely supported
if Clipboard.osc52_supported?() do
  Clipboard.write(content)
end
```

### PasteAccumulator

Accumulates bracketed paste content between markers:

```elixir
acc = PasteAccumulator.new()

# Start accumulation when paste start marker received
acc = PasteAccumulator.start(acc)

# Add content as it arrives
acc = PasteAccumulator.add(acc, "pasted ")
acc = PasteAccumulator.add(acc, "content")

# Complete when paste end marker received
{content, acc} = PasteAccumulator.complete(acc)
# content = "pasted content"

# Check for timeout on incomplete paste
if PasteAccumulator.timed_out?(acc, 5000) do
  acc = PasteAccumulator.reset(acc)
end
```

### Selection

Tracks selection state for copy operations:

```elixir
text = "Hello World Example"

# Start selection at cursor position
selection = Selection.new()
selection = Selection.start(selection, 0)

# Extend to new position
selection = Selection.extend(selection, 5)

# Extract selected content
Selection.extract(selection, text)  # => "Hello"

# Get selection range
Selection.range(selection)  # => {0, 5}

# Check if position is selected
Selection.contains?(selection, 3)  # => true

# Expand in direction
selection = Selection.expand(selection, :word_right, text, cursor)
selection = Selection.expand(selection, :line_end, text, cursor)

# Select word at position
selection = Selection.select_word(selection, text, 8)
Selection.extract(selection, text)  # => "Example"

# Select all
selection = Selection.select_all(selection, text)
```

## Features

### OSC 52 Clipboard Writing

```elixir
# Write to clipboard
Clipboard.write("text")

# Write to primary selection (X11)
Clipboard.write("text", target: :primary)

# Clear clipboard
Clipboard.clear()

# Generate sequence without writing
seq = Clipboard.write_sequence("text")
# => "\e]52;c;dGV4dA==\e\\"
```

### Bracketed Paste Mode

```elixir
# Enable/disable
IO.write(Clipboard.bracketed_paste_on())   # => \e[?2004h
IO.write(Clipboard.bracketed_paste_off())  # => \e[?2004l

# Markers for parsing
Clipboard.paste_start_marker()  # => \e[200~
Clipboard.paste_end_marker()    # => \e[201~
```

### Selection Operations

- `start/2` - Begin selection at position
- `extend/2` - Extend to new position
- `clear/1` - Clear selection
- `extract/2` - Get selected text
- `contains?/2` - Check if position selected
- `move/2` - Shift selection by delta
- `expand/4` - Expand in direction (:left, :right, :word_left, :word_right, :line_start, :line_end)
- `select_all/2` - Select entire text
- `select_word/3` - Select word at position

### Terminal Support Detection

```elixir
# Heuristic check for OSC 52 support
# Returns true for: iTerm2, Alacritty, WezTerm, Kitty, xterm, foot
Clipboard.osc52_supported?()
```

## Design Decisions

1. **OSC 52 for clipboard writing** - Cross-platform clipboard access without external dependencies
2. **Bracketed paste mode** - Prevents pasted content from being interpreted as commands
3. **Selection as utility module** - Components manage their own selection state
4. **PasteAccumulator state machine** - Clean handling of paste start/content/end flow
5. **Timeout for incomplete pastes** - Prevents stuck state on malformed input

## Test Coverage

51 tests covering:
- OSC 52 sequence generation (clipboard, primary, clear)
- Base64 encoding for content
- Bracketed paste markers
- PasteAccumulator state machine
- Selection start/extend/clear
- Selection extraction and range
- Selection contains and move
- Selection expansion in directions
- Word and all selection
- Terminal support detection

## Usage Example

```elixir
# In application - enable bracketed paste
IO.write(Clipboard.bracketed_paste_on())

# In input parser - accumulate paste content
defmodule PasteHandler do
  def handle_input(input, acc) do
    cond do
      String.starts_with?(input, Clipboard.paste_start_marker()) ->
        PasteAccumulator.start(acc)

      String.starts_with?(input, Clipboard.paste_end_marker()) ->
        {content, acc} = PasteAccumulator.complete(acc)
        send(self(), {:paste_event, content})
        acc

      PasteAccumulator.accumulating?(acc) ->
        PasteAccumulator.add(acc, input)

      true ->
        # Normal input handling
        acc
    end
  end
end

# In component - handle copy/paste
def update(:copy, state) do
  content = Selection.extract(state.selection, state.text)
  if content != "" do
    Clipboard.write(content)
  end
  {state, []}
end

def update({:paste, content}, state) do
  new_text = insert_at_cursor(state.text, content, state.cursor)
  {%{state | text: new_text}, []}
end
```

## Integration Points

- **Event system** - Paste events delivered as Event.Paste
- **Components** - Manage selection state for text editing
- **Terminal setup** - Enable bracketed paste mode
- **Shortcut system** - Register Ctrl+C/V/X shortcuts

