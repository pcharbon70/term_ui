# Summary: Section 7.2 - Mouse Input Support

## What Was Implemented

This section adds complete mouse input support to TermUI, enabling click, drag, scroll, and motion tracking in TUI applications.

### Modified Modules

1. **`TermUI.Terminal`** (`lib/term_ui/terminal.ex`)
   - Added mouse tracking escape sequence constants
   - Added `enable_mouse_tracking/1` with modes: `:click`, `:drag`, `:all`
   - Added `disable_mouse_tracking/0`
   - Added GenServer handlers for mouse mode calls
   - Updated `do_restore/1` to disable mouse tracking on shutdown
   - Added `disable_current_mouse_mode/1` helper

2. **`TermUI.Terminal.EscapeParser`** (`lib/term_ui/terminal/escape_parser.ex`)
   - Added SGR mouse sequence parsing (`ESC[<Cb;Cx;CyM/m`)
   - Added `parse_sgr_mouse/1` function
   - Added mouse parameter parsing and button code decoding
   - Supports press, release, drag, and scroll events
   - Extracts modifiers (Shift, Alt, Ctrl) from button code
   - Converts 1-indexed terminal coordinates to 0-indexed

3. **`TermUI.Runtime`** (`lib/term_ui/runtime.ex`)
   - Enabled mouse tracking in `setup_terminal_and_buffers/0`

### New Test File

- `test/term_ui/terminal/mouse_test.exs` - 18 tests covering all mouse event types

## Mouse Tracking Modes

| Mode | Function | Description |
|------|----------|-------------|
| Click | `enable_mouse_tracking(:click)` | Report button press/release |
| Drag | `enable_mouse_tracking(:drag)` | Also report motion while button pressed |
| All | `enable_mouse_tracking(:all)` | Report all mouse motion |

All modes enable SGR extended coordinates (ESC[?1006h) for accurate positioning beyond column 223.

## SGR Mouse Event Format

Format: `ESC [ < Cb ; Cx ; Cy M` (press) or `ESC [ < Cb ; Cx ; Cy m` (release)

### Button Codes

| Code | Meaning |
|------|---------|
| 0 | Left button |
| 1 | Middle button |
| 2 | Right button |
| 32 | Motion flag (add to button) |
| 64 | Scroll up |
| 65 | Scroll down |

### Modifier Flags (added to button code)

| Flag | Modifier |
|------|----------|
| 4 | Shift |
| 8 | Alt/Meta |
| 16 | Ctrl |

## Event.Mouse Actions

- `:press` - Button pressed
- `:release` - Button released
- `:drag` - Motion with button held
- `:scroll_up` - Scroll wheel up
- `:scroll_down` - Scroll wheel down

## Architecture

```
Terminal enables → stdin receives → EscapeParser decodes → Event.Mouse → Runtime dispatches
   mouse mode       SGR sequences      button/coords         to component
```

## Usage

```elixir
# Enable mouse tracking (done automatically by Runtime)
Terminal.enable_mouse_tracking(:click)

# In component's event_to_msg/2
def event_to_msg(%Event.Mouse{action: :press, button: :left, x: x, y: y}, _state) do
  {:msg, {:click, x, y}}
end

def event_to_msg(%Event.Mouse{action: :scroll_up}, _state) do
  {:msg, :scroll_up}
end

# Disable mouse tracking
Terminal.disable_mouse_tracking()
```

## Testing

### Test Coverage (18 tests)
- Button press parsing (left, middle, right)
- Button release parsing
- Scroll wheel events (up, down)
- Drag events
- Modifier detection (Shift, Alt, Ctrl, combinations)
- Coordinate conversion (1-indexed → 0-indexed)
- Incomplete sequence handling
- Mixed mouse and keyboard events

### Test Results
- All 18 new mouse tests pass
- All 2801 total tests pass (no regressions)

## Technical Notes

1. **SGR Mode Required**: SGR extended mode (1006) is enabled alongside tracking mode for accurate coordinates beyond 223.

2. **Coordinate Conversion**: Terminal sends 1-indexed coordinates; we convert to 0-indexed internally for consistency.

3. **Button Code Decoding**: Button codes use bitfields for button, motion flag, and modifiers - requires bitwise operations to decode.

4. **Release Button**: On release events, button_code is typically 3 (not the actual button), so we default to `:left`.

5. **Automatic Cleanup**: Mouse tracking is automatically disabled in `Terminal.restore/0` for clean shutdown.

## Files Changed

- Modified: `lib/term_ui/terminal.ex` (added mouse mode functions)
- Modified: `lib/term_ui/terminal/escape_parser.ex` (added SGR mouse parsing)
- Modified: `lib/term_ui/runtime.ex` (enabled mouse tracking in init)
- Created: `test/term_ui/terminal/mouse_test.exs`
- Created: `notes/features/7.2-mouse-input-support.md`
