# Summary: Task 2.3.3 - Implement Cursor Position Optimization

**Branch:** `feature/2.3.3-cursor-optimization`
**Date:** 2025-12-05
**Status:** Complete

## Overview

Integrated the existing `TermUI.Renderer.CursorOptimizer` module into the Raw backend's `move_cursor/2` function. This optimization reduces cursor movement bytes by choosing the cheapest movement option (absolute vs relative positioning).

## Implementation

### New Option: optimize_cursor

Added `optimize_cursor` field to Raw backend state:
- Default: `true` (optimization enabled)
- When `true`: Uses `CursorOptimizer.optimal_move/4` to find cheapest move
- When `false`: Uses absolute positioning only

### State Changes

```elixir
@type t :: %__MODULE__{
  # ... existing fields ...
  optimize_cursor: boolean()
}

defstruct # ... existing fields ...
          optimize_cursor: true
```

### Private Function: generate_cursor_sequence/3

Pattern-matched function that determines cursor movement sequence:

```elixir
# Optimization enabled with known position - use CursorOptimizer
defp generate_cursor_sequence(
       %__MODULE__{optimize_cursor: true, cursor_position: {from_row, from_col}},
       to_row,
       to_col
     ) do
  {sequence, _cost} = CursorOptimizer.optimal_move(from_row, from_col, to_row, to_col)
  sequence
end

# Optimization enabled but no current position - use absolute
defp generate_cursor_sequence(
       %__MODULE__{optimize_cursor: true, cursor_position: nil},
       row,
       col
     ) do
  ANSI.cursor_position(row, col)
end

# Optimization disabled - always use absolute
defp generate_cursor_sequence(%__MODULE__{optimize_cursor: false}, row, col) do
  ANSI.cursor_position(row, col)
end
```

## Tests Added

8 new tests in `describe "cursor optimization"`:

| Test | Description |
|------|-------------|
| optimize_cursor defaults to true | Verifies default value |
| optimize_cursor can be disabled via option | Tests init option |
| move_cursor works with optimization enabled | Sequential moves with optimization |
| move_cursor works with optimization disabled | Sequential moves without optimization |
| uses relative move for small horizontal distance | Validates CursorOptimizer integration |
| uses relative move for small vertical distance | Validates CursorOptimizer integration |
| handles nil cursor_position with optimization enabled | Falls back to absolute |
| preserves optimize_cursor setting across moves | State field persistence |

## Files Modified

| File | Changes |
|------|---------|
| `lib/term_ui/backend/raw.ex` | Added `optimize_cursor` field, integrated CursorOptimizer (+25 lines) |
| `test/term_ui/backend/raw_test.exs` | Added 8 optimization tests (+57 lines) |
| `notes/planning/multi-renderer/phase-02-raw-backend.md` | Marked Section 2.3 complete |

## Verification

- `mix compile` - Compiles without warnings
- `mix test test/term_ui/backend/raw_test.exs` - 77 tests pass (8 new)
- `mix format --check-formatted` - Code properly formatted

## Design Decisions

### Reuse Existing Module

Leveraged existing `TermUI.Renderer.CursorOptimizer` rather than reimplementing:
- `optimal_move/4` already implements cost calculation for all movement options
- Returns `{sequence, cost}` tuple, we use the sequence
- Handles CR, home, newline, space, and relative moves

### Fallback for Unknown Position

When `cursor_position` is `nil`, falls back to absolute positioning since we can't calculate relative cost without knowing the starting point.

### Optional Optimization

Made optimization optional via init option to allow:
- Predictable output for debugging
- Testing without optimization overhead
- Users who prefer absolute positioning

## Impact

- **Section 2.3 complete**: All cursor operations implemented
- **No breaking changes**: Existing behavior preserved (optimization enabled by default produces functionally equivalent output)
- **Performance**: Reduced cursor movement bytes for sequential rendering operations
