# CommandPalette Widget Summary (6.9.2)

## Overview

The CommandPalette widget provides VS Code-style command discovery and execution for TermUI applications. It supports fuzzy search, category filtering, recent commands, keyboard shortcuts, nested menus, and async command loading.

## Features Implemented

### Modal Overlay (6.9.2.1)
- Renders as a centered modal overlay
- Configurable width (default: 60)
- Box drawing characters for visual border
- Visibility toggle via API (`show/1`, `hide/1`, `toggle/1`)

### Fuzzy Search (6.9.2.2)
- Scoring algorithm with multiple factors:
  - Exact match: +100 points
  - Prefix match: +50 points + length bonus
  - Contains match: +30 points + length bonus
  - Fuzzy match with consecutive/boundary bonuses
- Case-insensitive search
- Results sorted by score (highest first)
- Match highlighting in results

### Category Prefixes (6.9.2.3)
- `>` - Commands (default)
- `@` - Symbols/Go to
- `#` - Tags/Topics
- `:` - Line numbers/Locations
- Category filter applied before fuzzy search
- Category indicator displayed in search input

### Recent Commands (6.9.2.4)
- Tracks recently executed commands
- Recent commands shown first when query is empty
- Configurable maximum recent count (default: 5)
- `clear_recent_commands/1` API for reset

### Keyboard Shortcut Hints (6.9.2.5)
- Shortcuts displayed right-aligned in command rows
- Format: `[Ctrl+S]` or similar
- Graceful handling of missing shortcuts

### Nested Command Menus (6.9.2.6)
- Commands can have `{:submenu, commands}` action
- Submenu stack for deep nesting
- Backspace (on empty query) to go back
- Escape to go back from submenu
- Breadcrumb display in header

### Async Command Loading (6.9.2.7)
- Commands can have `{:async, loader_fn}` action
- Loader function receives current query
- Loading indicator displayed while loading
- Error handling for failed loads
- Results pushed as submenu

## Public API

### Initialization
- `new/1` - Create palette props from options
- `init/1` - Initialize palette state

### Visibility
- `show/1` - Show the palette
- `hide/1` - Hide the palette
- `toggle/1` - Toggle visibility
- `visible?/1` - Check visibility status

### Query Management
- `get_query/1` - Get current search query
- `set_query/2` - Set search query programmatically

### Command Access
- `get_filtered_commands/1` - Get filtered command list
- `get_selected_command/1` - Get currently selected command
- `get_recent_commands/1` - Get recent command IDs
- `clear_recent_commands/1` - Clear recent commands

### Dynamic Commands
- `add_commands/2` - Add new commands
- `remove_commands/2` - Remove commands by ID

### Metadata
- `category_prefixes/0` - Get category prefix map

## State Structure

```elixir
%{
  commands: [command()],
  filtered_commands: [command()],
  query: String.t(),
  selected_index: integer(),
  recent_commands: [atom()],
  max_recent: integer(),
  max_visible: integer(),
  visible: boolean(),
  loading: boolean(),
  category_filter: atom() | nil,
  on_select: callback,
  on_close: callback,
  placeholder: String.t(),
  width: integer(),
  submenu_stack: [submenu_entry()],
  scroll_offset: integer()
}
```

## Command Structure

```elixir
%{
  id: atom(),
  label: String.t(),
  description: String.t() | nil,
  shortcut: String.t() | nil,
  category: :command | :symbol | :tag | :location,
  action: (-> term()) | {:submenu, [command()]} | {:async, (String.t() -> [command()])},
  icon: String.t() | nil,
  enabled: boolean() | (-> boolean())
}
```

## Keyboard Navigation

- Up/Down: Navigate through results
- Enter: Execute selected command
- Escape: Close palette (or go back from submenu)
- Backspace: Delete character / go back from submenu (when query empty)
- PageUp/PageDown: Jump through results

## Files Created

- `lib/term_ui/widgets/command_palette.ex` - Main widget (550+ lines)
- `test/term_ui/widgets/command_palette_test.exs` - 49 tests
- `examples/command_palette/` - Example application
- `notes/features/6.9.2-command-palette.md` - Feature planning document

## Test Results

All 49 tests pass:
- Initialization tests
- Fuzzy search tests (exact, prefix, partial, case-insensitive)
- Category filtering tests
- Navigation tests (up, down, page up, page down)
- Text input tests
- Command execution tests
- Recent commands tests
- Submenu tests
- Visibility tests
- Public API tests
- Rendering tests
- Async loading tests

## Usage Example

```elixir
props = CommandPalette.new(
  commands: [
    %{id: :save, label: "Save File", shortcut: "Ctrl+S",
      action: fn -> save_file() end},
    %{id: :open, label: "Open File", shortcut: "Ctrl+O",
      action: fn -> open_file() end},
    %{id: :settings, label: "Settings",
      action: {:submenu, [
        %{id: :theme, label: "Theme", action: fn -> change_theme() end},
        %{id: :font, label: "Font", action: fn -> change_font() end}
      ]}}
  ],
  on_select: fn cmd -> handle_command(cmd) end,
  on_close: fn -> close_palette() end,
  max_visible: 10,
  placeholder: "Type to search..."
)

{:ok, state} = CommandPalette.init(props)
```

## How to Run Example

```bash
cd examples/command_palette
mix deps.get
iex -S mix
CommandPalette.run()
```

## Notes

- The widget uses `@behaviour TermUI.Elm` pattern for examples to avoid import conflicts
- Async loading currently executes synchronously (Task-based async would be needed for true background loading)
- The fuzzy search algorithm balances speed and accuracy for typical command lists
