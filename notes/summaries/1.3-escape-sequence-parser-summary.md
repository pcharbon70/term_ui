# Summary: Section 1.3 Escape Sequence Parser

## Overview

Implemented a state machine parser that transforms raw terminal input bytes into structured events (key presses, mouse actions, paste content, focus changes). This parser is the foundation for all user input handling in TermUI.

## Completed Tasks

### 1.3.1 Event Data Structures
- ✅ `KeyEvent` - Keyboard input with key (atom/string) and modifiers list
- ✅ `MouseEvent` - Mouse actions with button, position, action, and modifiers
- ✅ `PasteEvent` - Bracketed paste content
- ✅ `FocusEvent` - Terminal focus gained/lost events
- ✅ `ResizeEvent` - Terminal resize events (struct defined for future use)

### 1.3.2-1.3.6 State Machine Parser
- ✅ Parser state struct with mode, buffer, params, paste_buffer
- ✅ Main `parse/2` function with incremental parsing support
- ✅ Control character parsing (Ctrl+key combinations)
- ✅ CSI sequence handling (arrow keys, function keys, special keys)
- ✅ SS3 sequence handling (F1-F4, application mode arrows)
- ✅ Modifier parameter extraction (Shift, Alt, Ctrl, Meta)
- ✅ X10 mouse event parsing
- ✅ SGR mouse event parsing
- ✅ Bracketed paste accumulation
- ✅ Focus event parsing
- ✅ UTF-8 character support
- ✅ Split sequence handling across parse calls

## Architecture

### Module Structure
```
lib/term_ui/
├── parser.ex           # Main parser module with state machine (465 lines)
└── parser/
    └── events.ex       # Event struct definitions (88 lines)
```

### Key Design Decisions
1. **Map-based lookups** - Control chars, CSI keys, SS3 keys all use module attribute maps
2. **Incremental parsing** - Parser state persists across calls for split sequences
3. **Event structs** - Type-safe, pattern-matchable event representations
4. **No timeout in core parser** - Caller handles timeout for ESC disambiguation

### Parser States
- `:ground` - Normal input processing
- `:escape` - Received ESC, waiting for more
- `:csi` - In CSI sequence (ESC[)
- `:ss3` - In SS3 sequence (ESCO)
- `:sgr_mouse` - Collecting SGR mouse parameters
- `:paste` - Accumulating paste content

## Test Coverage

49 tests covering:
- Parser state management (new, reset, flush_escape)
- Single character parsing (ASCII, UTF-8, special chars)
- Control character parsing (Ctrl+a through Ctrl+z)
- Escape sequences and Alt+key combinations
- CSI arrow keys with modifiers
- CSI special keys (Home, End, Insert, Delete, Page Up/Down)
- Function keys F1-F12 (both SS3 and CSI formats)
- X10 mouse events (button press, release, motion, wheel, modifiers)
- SGR mouse events (with large coordinates support)
- Focus events (gained/lost)
- Bracketed paste (simple, special chars, empty, split across calls)
- Incremental parsing (split sequences)
- Mixed input sequences

## API Highlights

```elixir
# Create parser state
state = TermUI.Parser.new()

# Parse input bytes
{events, remaining, state} = TermUI.Parser.parse(input, state)

# Flush pending escape after timeout
{[event], state} = TermUI.Parser.flush_escape(state)

# Reset parser
state = TermUI.Parser.reset(state)
```

### Event Examples

```elixir
# Key events
%KeyEvent{key: "a", modifiers: []}
%KeyEvent{key: :up, modifiers: [:ctrl, :shift]}
%KeyEvent{key: :f5, modifiers: []}

# Mouse events
%MouseEvent{action: :press, button: :left, x: 10, y: 5, modifiers: []}
%MouseEvent{action: :release, button: :right, x: 20, y: 15, modifiers: [:ctrl]}
%MouseEvent{action: :motion, button: :left, x: 100, y: 50, modifiers: []}

# Other events
%PasteEvent{content: "pasted text"}
%FocusEvent{focused: true}
```

## Files Created

- `lib/term_ui/parser.ex` - State machine parser (465 lines)
- `lib/term_ui/parser/events.ex` - Event struct definitions (88 lines)
- `test/term_ui/parser_test.exs` - Comprehensive tests (49 tests)
- `notes/features/1.3-escape-sequence-parser.md` - Feature plan
- `notes/summaries/1.3-escape-sequence-parser-summary.md` - This summary

## Key Sequence Reference

### Supported Input Types
- **Single characters**: ASCII, UTF-8
- **Control characters**: 0x00-0x1A (Ctrl+Space through Ctrl+Z)
- **Arrow keys**: ESC[A-D, ESCO A-D (application mode)
- **Function keys**: F1-F4 (ESCOP-S), F5-F12 (ESC[15~-24~)
- **Special keys**: Home, End, Insert, Delete, Page Up/Down
- **Modifiers**: Shift (;2), Alt (;3), Ctrl (;5), combinations
- **Mouse X10**: ESC[M + 3 bytes
- **Mouse SGR**: ESC[<btn;col;rowM/m
- **Bracketed paste**: ESC[200~ ... ESC[201~
- **Focus**: ESC[I (in), ESC[O (out)

### Modifier Encoding
CSI parameter: `1 + (shift?1:0) + (alt?2:0) + (ctrl?4:0) + (meta?8:0)`
- 2 = Shift
- 3 = Alt
- 5 = Ctrl
- 7 = Ctrl+Alt

## How to Run

```bash
cd /home/ducky/code/term_ui
mix test test/term_ui/parser_test.exs
```

## Next Steps

This module provides the foundation for:
- **Phase 5**: Event System will route these parsed events to components
- **Input handling**: All user interaction flows through this parser
- **Terminal driver**: Will feed raw input to parser for processing
