# Summary: Section 2.3 Diff Algorithm

## Overview

Implemented the differential rendering algorithm that compares current and previous buffers to produce minimal render operations. This enables efficient terminal updates by only redrawing changed portions of the screen.

## Completed Tasks

### 2.3.1 Cell Comparison
- `Cell.equal?/2` comparing all cell properties (already existed)
- Early-exit optimization for common case
- Handles character, fg, bg, and attributes

### 2.3.2 Row-Based Diffing
- `diff_row/4` comparing corresponding rows
- `find_changed_spans/3` detecting contiguous changes
- Unchanged rows skipped entirely
- Extracted helper functions for clean code structure

### 2.3.3 Change Span Optimization
- `merge_spans/1` combining adjacent spans with small gaps
- Gap threshold of 3 columns (smaller than cursor move cost)
- Spans split on style changes for efficient SGR output

### 2.3.4 Wide Character Handling
- `wide_char?/1` detecting double-width characters
- DisplayWidth integration for CJK detection
- Foundation for pair inclusion in spans

### 2.3.5 Diff Output Generation
- Defined operation types: `{:move, row, col}`, `{:style, style}`, `{:text, string}`
- `span_to_operations/1` generating operations from spans
- `optimize_operations/1` merging adjacent text and removing redundant styles
- Style grouping for efficient SGR sequences

### Supporting Additions
- `Style.equal?/2` for comparing styles in diff
- Refactored nested functions to reduce nesting depth (Credo compliance)

## Architecture

### File Structure
```
lib/term_ui/renderer/
├── diff.ex              # NEW: ~285 lines
└── style.ex             # Modified: added equal?/2

test/term_ui/renderer/
└── diff_test.exs        # NEW: 34 tests
```

### Key Design Decisions
1. **Row-major iteration** - Matches terminal's efficient row output
2. **Span-based output** - Groups contiguous changes to minimize cursor moves
3. **Style delta tracking** - Only emits changed style attributes
4. **Gap merging threshold** - Includes small gaps when cheaper than cursor move

## Test Coverage

34 new unit tests covering:
- Buffer diffing (identical, single change, multiple changes)
- Row diffing (unchanged, style changes)
- Span finding and merging
- Operation generation and optimization
- Wide character detection
- Style equality
- Integration scenarios (partial update, deterministic output)

Total project tests: **550 tests, 0 failures**

## API Highlights

### Basic Diff Usage
```elixir
# Compare buffers and get operations
operations = Diff.diff(current_buffer, previous_buffer)
# => [{:move, 1, 1}, {:style, %Style{}}, {:text, "Hello"}, ...]
```

### Operation Types
```elixir
{:move, row, col}   # Move cursor to position
{:style, style}     # Set text style
{:text, string}     # Output text at cursor
:reset              # Reset all styles
```

### Span Detection
```elixir
# Find changed spans in a row
spans = Diff.find_changed_spans(current_cells, previous_cells, row)
# => [%{row: 1, start_col: 5, end_col: 10, cells: [...]}]
```

### Style Comparison
```elixir
Style.equal?(style1, style2)  # => true/false
```

## Optimizations

### Span Merging
- Adjacent spans with gap < 3 columns are merged
- Includes unchanged cells when cheaper than cursor move

### Style Grouping
- Consecutive cells with same style grouped together
- Reduces number of SGR sequences

### Redundant Style Removal
- Consecutive identical styles collapsed
- Only emits style when it changes

## Files Created/Modified

- `lib/term_ui/renderer/diff.ex` - Diff algorithm (~285 lines)
- `lib/term_ui/renderer/style.ex` - Added `equal?/2` function
- `test/term_ui/renderer/diff_test.exs` - 34 tests
- `notes/features/2.3-diff-algorithm.md` - Feature plan
- `notes/summaries/2.3-diff-algorithm-summary.md` - This summary

## Next Steps

Section 2.4 will build on the diff algorithm to implement:
- Cursor optimization for minimal movement
- Movement cost model (absolute vs relative)
- Optimal path selection between positions
- Cursor position tracking during render

The diff algorithm provides the foundation for:
- Efficient partial screen updates
- Smooth animations without flicker
- Reduced terminal I/O for responsive performance
