# Summary: Section 7.5 - Graceful Shutdown

## What Was Implemented

This section completes graceful shutdown handling, ensuring TUI applications properly clean up and restore the terminal when exiting.

### Modified Modules

1. **`TermUI.Command`** (`lib/term_ui/command.ex`)
   - Added `:quit` command type
   - Added `quit/0` and `quit/1` functions
   - Added validation for quit commands

2. **`TermUI.Runtime`** (`lib/term_ui/runtime.ex`)
   - Added `Process.flag(:trap_exit, true)` in init for crash recovery
   - Updated `execute_commands/2` to detect and handle quit commands
   - Updated `initiate_shutdown/1` to stop the GenServer
   - Added `handle_info(:stop_runtime, state)` handler
   - Wrapped terminate cleanup in try/rescue for crash resilience

3. **`TermUI.Terminal`** (`lib/term_ui/terminal.ex`)
   - Added reset terminal attributes (`ESC[0m`) in `do_restore/1`

### New Test File

- `test/term_ui/runtime/shutdown_test.exs` - 15 tests

### Updated Test File

- `test/term_ui/runtime_test.exs` - Updated shutdown-related tests for new behavior

## Architecture

```
Component                    Runtime                      Terminal
    │                           │                            │
    │  {state, [Command.quit()]}│                            │
    ├──────────────────────────>│                            │
    │                           │ execute_commands           │
    │                           │ detects :quit              │
    │                           │                            │
    │                           │ cast :shutdown             │
    │                           │                            │
    │                           │ initiate_shutdown          │
    │                           │ - set shutting_down        │
    │                           │ - clear pending_commands   │
    │                           │ - clear components         │
    │                           │ - schedule :stop_runtime   │
    │                           │                            │
    │                           │ terminate/2                │
    │                           │ - stop InputReader         │
    │                           │ - unregister resize        │
    │                           │────────────────────────────>│
    │                           │                    restore()│
    │                           │                    - cursor │
    │                           │                    - mouse  │
    │                           │                    - screen │
    │                           │                    - raw    │
    │                           │<────────────────────────────│
    │                           │                            │
    │                    :stop  │                            │
```

## Implementation Details

### Command.quit/1

```elixir
@spec quit(term()) :: t()
def quit(reason \\ :normal) do
  %__MODULE__{
    type: :quit,
    payload: reason,
    on_result: nil
  }
end
```

### Quit Command Detection

The `execute_commands/2` function checks for quit commands:

```elixir
quit_cmd = Enum.find(commands, fn {_component_id, cmd} ->
  case cmd do
    %{type: :quit} -> true
    :quit -> true  # Legacy atom support
    _ -> false
  end
end)

if quit_cmd do
  GenServer.cast(self(), :shutdown)
  %{state | shutting_down: true}
else
  # ... track pending commands
end
```

### Crash-Resilient Cleanup

All cleanup steps are wrapped in try/rescue:

```elixir
def terminate(_reason, state) do
  try do
    if state.input_reader, do: InputReader.stop(state.input_reader)
  rescue
    _ -> :ok
  end

  try do
    if state.terminal_started, do: Terminal.unregister_resize_callback(self())
  rescue
    _ -> :ok
  end

  # ... more cleanup steps
end
```

### Terminal Restoration

The Terminal's `do_restore/1` now includes attribute reset:

```elixir
defp do_restore(state) do
  if not state.cursor_visible, do: write_to_terminal(@show_cursor)
  if state.mouse_tracking != :off, do: disable_mouse_mode()
  if state.alternate_screen_active, do: write_to_terminal(@leave_alternate_screen)
  if state.raw_mode_active, do: do_disable_raw_mode(state.original_settings)

  # Reset terminal attributes (colors, styles)
  write_to_terminal("\e[0m")

  # ... rest of cleanup
end
```

## Usage

Components can request application exit:

```elixir
def update(:user_quit, state) do
  {state, [Command.quit()]}
end

def update(:error_exit, state) do
  {state, [Command.quit({:error, :some_reason})]}
end
```

## Testing

### Test Coverage (15 new + updated tests)

- Command.quit/0 and quit/1 creation
- Quit command validation
- Runtime shutdown via quit command
- Shutdown flag behavior
- Process stops after shutdown
- Events/messages ignored during shutdown
- trap_exit enabled
- Double shutdown safety

### Test Results

- All 15 new shutdown tests pass
- All 2834 total tests pass (no regressions)
- Updated 6 existing tests to match new shutdown behavior

## Technical Notes

1. **trap_exit**: The Runtime now sets `Process.flag(:trap_exit, true)` to ensure `terminate/2` is always called, even on crashes.

2. **Graceful Stop**: The GenServer stops via `Process.send_after(self(), :stop_runtime, 0)` after cleanup, allowing `terminate/2` to run properly.

3. **Legacy Support**: Both `Command.quit()` structs and legacy `:quit` atoms are supported for backward compatibility.

4. **Crash Resilience**: Each cleanup step is wrapped in try/rescue so failures don't prevent other cleanup from running.

5. **Attribute Reset**: Added `ESC[0m` to terminal restoration to ensure colors/styles are cleared.

## Files Changed

- Modified: `lib/term_ui/command.ex` (added :quit command type)
- Modified: `lib/term_ui/runtime.ex` (shutdown handling)
- Modified: `lib/term_ui/terminal.ex` (attribute reset in restore)
- Modified: `test/term_ui/runtime_test.exs` (updated shutdown tests)
- Created: `test/term_ui/runtime/shutdown_test.exs`
- Created: `notes/features/7.5-graceful-shutdown.md`
- Created: `notes/summaries/7.5-graceful-shutdown.md`

## Key Benefits

1. **Clean Exit**: Applications can request exit via Command.quit()
2. **Full Restoration**: Terminal is restored completely (cursor, screen, mouse, raw mode, attributes)
3. **Crash Safety**: Cleanup runs even after crashes due to trap_exit
4. **Resilient Cleanup**: Individual cleanup failures don't prevent other cleanup
5. **Proper Process Lifecycle**: Runtime GenServer stops cleanly after shutdown
