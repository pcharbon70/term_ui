# Feature: Section 2.1 Review Fixes

## Overview

Address all blockers, concerns, and suggestions from the Section 2.1 code review documented in `notes/reviews/section-2.1-raw-backend-structure-review.md`.

## Reference

- Review document: `notes/reviews/section-2.1-raw-backend-structure-review.md`
- Branch: `feature/2.1-review-fixes`
- Parent branch: `multi-renderer`

## Tasks

### BLOCKER

- [x] **Mouse mode naming inconsistency**
  - Raw backend uses: `:none`, `:click`, `:drag`, `:all`
  - Terminal module uses: `:off`, `:click`, `:drag`, `:all` (state tracks with `:off`)
  - ANSI module uses: `:x10`, `:normal`, `:button`, `:all`
  - **Solution**: Document the mapping in Raw backend, use consistent names at Raw level that map to ANSI internally
  - The Raw backend values are user-facing and intuitive (`:click`, `:drag`, `:all`)
  - Document the mapping to ANSI protocol names

### CONCERNS

- [x] **1. Position type inconsistency**
  - Backend uses `non_neg_integer()` (allows 0)
  - Raw uses `pos_integer()` (requires > 0)
  - Terminal positions are 1-indexed, so `pos_integer()` is correct
  - **Solution**: Update Backend behaviour position type to use `pos_integer()`

- [x] **2. Document current_style field**
  - Field exists but purpose not clear
  - **Solution**: Add documentation explaining style delta optimization

- [x] **3. Generic stub test assertions**
  - Tests accept any result tuple pattern
  - **Solution**: Make assertions more specific where possible

- [x] **4. Test fixture duplication**
  - `Raw.init([])` called 8 times
  - **Solution**: Extract to ExUnit setup block

- [x] **5. Escape sequence duplication**
  - Terminal module has hard-coded escape sequences
  - ANSI module has functions for same sequences
  - **Solution**: Refactor Terminal to use ANSI module functions

### SUGGESTIONS

- [x] **1. Document style delta optimization**
  - Add comprehensive documentation for how current_style enables optimization

- [x] **2. Add state validation helpers**
  - Add `valid_position?/2` helper function

- [x] **3. Add error handling documentation**
  - Document expected error reasons in callback @doc sections

- [x] **4. Add guard clauses pattern**
  - Show pattern for position validation in at least one callback

- [x] **5. Clean up task references**
  - Generalize section headers, keep task refs in comments only

## Implementation Plan

### Phase 1: Fix Blocker (Mouse Mode)
1. Add detailed `@moduledoc` section explaining mouse mode mapping
2. Document that Raw `:click` maps to ANSI `:normal`, Raw `:drag` maps to ANSI `:button`

### Phase 2: Fix Concerns
1. Update Backend position type from `non_neg_integer()` to `pos_integer()`
2. Add style delta optimization documentation to current_style field
3. Update test assertions to be more specific
4. Extract test setup using ExUnit setup block
5. Refactor Terminal module to use ANSI module functions

### Phase 3: Implement Suggestions
1. Add comprehensive style delta optimization section
2. Add `valid_position?/2` helper function
3. Add error reason documentation to callbacks
4. Add guard clause to `move_cursor/2` as example pattern
5. Clean up section headers to be more generic

### Phase 4: Verify
1. Run `mix compile --warnings-as-errors`
2. Run `mix test`
3. Run `mix format --check-formatted`

## Files to Modify

- `lib/term_ui/backend.ex` - Position type fix
- `lib/term_ui/backend/raw.ex` - Documentation and helpers
- `lib/term_ui/terminal.ex` - Use ANSI module functions
- `test/term_ui/backend/raw_test.exs` - Test improvements

## Testing Strategy

- All existing tests must pass
- No new tests required (improvements to existing tests)
