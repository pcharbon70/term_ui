# Feature Plan: 2.4 Cursor Optimization

## Problem Statement

The rendering engine needs to minimize cursor movement overhead. Naive absolute positioning (`ESC[{row};{col}H`) adds 6-10 bytes per move. We can often use cheaper alternatives:
- Relative movements (up/down/left/right) cost 3-6 bytes
- Special movements (CR, LF, home) cost 1-3 bytes
- Literal spaces cost 1 byte each for small rightward moves

By selecting the cheapest movement option for each cursor repositioning, we can reduce output bytes by 40%+ compared to naive absolute positioning.

## Solution Overview

Implement a CursorOptimizer module that:
1. Calculates cost for each movement option
2. Selects the cheapest option for moving between positions
3. Tracks cursor position during rendering
4. Integrates with the diff output pipeline

### Key Design Decisions

- **Cost-based selection** - Calculate byte cost for each option, choose minimum
- **Stateful tracking** - Maintain cursor position to enable relative moves
- **Escape sequence generation** - Output actual sequences, not just costs
- **Integration with diff** - Process `{:move, row, col}` operations

## Technical Details

### File Structure
```
lib/term_ui/renderer/
├── cursor_optimizer.ex  # NEW: Cursor movement optimization

test/term_ui/renderer/
├── cursor_optimizer_test.exs  # NEW: Tests for cursor optimizer
```

### Dependencies
- Section 2.3: Diff module producing `{:move, row, col}` operations
- Phase 1: Escape sequence constants

### Escape Sequence Costs

| Movement | Sequence | Byte Cost |
|----------|----------|-----------|
| Absolute | `ESC[{r};{c}H` | 6-10 |
| Up n | `ESC[{n}A` | 4-6 |
| Down n | `ESC[{n}B` | 4-6 |
| Right n | `ESC[{n}C` | 4-6 |
| Left n | `ESC[{n}D` | 4-6 |
| Home | `ESC[H` | 3 |
| Carriage Return | `\r` | 1 |
| Newline | `\n` | 1 |
| Space (rightward) | ` ` | 1 each |

## Implementation Plan

### Task 2.4.1: Movement Cost Model ✅
- [x] 2.4.1.1 Implement `cost_absolute/2` calculating escape sequence length
- [x] 2.4.1.2 Implement relative movement costs (`cost_up/1`, `cost_down/1`, `cost_left/1`, `cost_right/1`)
- [x] 2.4.1.3 Implement special movement costs (CR, LF, home)
- [x] 2.4.1.4 Implement literal space cost for small rightward movements

### Task 2.4.2: Optimal Path Selection ✅
- [x] 2.4.2.1 Implement `optimal_move/2` returning cheapest movement sequence
- [x] 2.4.2.2 Enumerate viable movement options (absolute, relative, combinations)
- [x] 2.4.2.3 Compare costs and select minimum
- [x] 2.4.2.4 Generate actual escape sequences for chosen option

### Task 2.4.3: Cursor Position Tracking ✅
- [x] 2.4.3.1 Track current row and column during render
- [x] 2.4.3.2 Update position after movement operations
- [x] 2.4.3.3 Update position after text output (advance by display width)
- [x] 2.4.3.4 Handle edge cases (position 1,1 on start)

### Task 2.4.4: Movement Sequence Integration ✅
- [x] 2.4.4.1 Process diff operations and optimize moves
- [x] 2.4.4.2 Generate iodata output for movement sequences
- [x] 2.4.4.3 Track statistics (bytes saved)
- [x] 2.4.4.4 Provide fallback to absolute positioning

### Unit Tests ✅
- [x] Test movement cost calculations return correct byte counts
- [x] Test optimal path selection chooses cheapest option
- [x] Test CR+down chosen over absolute for column 1
- [x] Test literal spaces used for small rightward moves
- [x] Test cursor position tracking stays synchronized
- [x] Test text output advances cursor by display width
- [x] Test optimization produces shorter output than naive
- [x] Test fallback to absolute positioning

## Success Criteria

1. Cost functions return accurate byte counts for all movement types
2. Optimal path selection reduces cursor movement bytes by 30%+
3. Cursor position tracking remains synchronized during render
4. Generated escape sequences are correct
5. All unit tests pass
6. Credo strict mode passes

## Current Status

**Status**: ✅ Complete

### What Works
- Movement cost model for all escape sequence types
- Optimal path selection with cost comparison
- Cursor position tracking
- Escape sequence generation
- Statistics tracking for bytes saved
- 42 unit tests passing

### What's Next
- Section 2.5: Escape Sequence Batching

### How to Run
```bash
mix test test/term_ui/renderer/cursor_optimizer_test.exs
mix credo --strict
```

## Notes

- CR+down is often cheaper than absolute for column 1 positions
- Spaces are cheaper than cursor right for 1-3 character moves
- Position tracking must account for display width of characters
- Initial cursor position assumed to be (1, 1)
