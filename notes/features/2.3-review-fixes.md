# Feature: Section 2.3 Review Fixes

**Branch:** `feature/2.3-review-fixes`
**Base:** `multi-renderer`
**Date:** 2025-12-05

## Overview

Address all concerns and implement suggestions from the Section 2.3 code review (`notes/reviews/section-2.3-cursor-operations-review.md`).

## Concerns to Fix

### Concern #1: Document Bounds Checking Contract
- Add documentation clarifying that bounds validation is caller's responsibility
- Update `move_cursor/2` @doc to explain terminal clamping behavior
- Reference `valid_position?/2` helper for callers who need validation

### Concern #2: Add Output Verification Tests
- Add tests that verify actual ANSI sequences generated
- Test optimizer selection (relative vs absolute) for known scenarios
- Use IO capture or mock to verify output

### Concern #3: Add CursorOptimizer Error Handling
- Add rescue clause in `generate_cursor_sequence/3`
- Fall back to absolute positioning if optimizer fails
- Log warning for debugging

### Concern #4: Document Idempotent Semantics
- Add note to `hide_cursor/1` and `show_cursor/1` docs
- Explain that same state object is returned when already in desired state
- Note that no ANSI sequences are emitted in idempotent case

### Concern #5: Add Bounds Checking to CursorOptimizer
- Add `@max_cursor_pos` constant (9999)
- Add validation in `advance/2` and `optimal_move/4`
- Prevent integer overflow with large values

## Suggestions to Implement

### Suggestion #1: Reorder Function Clauses
- Move nil cursor_position clause before tuple clause
- Follows convention of most specific to general

### Suggestion #2: Consolidate generate_cursor_sequence Clauses
- Combine clauses that return same result (nil position, optimization disabled)
- Reduces code duplication

### Suggestion #3: Add Test Helper for State Preservation
- Create `assert_state_unchanged_except/3` helper
- Reduce repeated assertion patterns in tests

### Suggestion #4: Add Telemetry Instrumentation
- Add optional telemetry for cursor optimization
- Track bytes saved, from/to positions
- Use `:telemetry.execute/3`

### Suggestion #5: Add Cross-Reference Documentation
- Add "See Also" sections to cursor functions
- Link related functions together

### Suggestion #6: Add Large Distance Fallback Test
- Test that optimizer uses absolute for long moves
- Verify behavior matches expected optimization strategy

## Files to Modify

- `lib/term_ui/backend/raw.ex` - Documentation, error handling, clause reordering
- `lib/term_ui/renderer/cursor_optimizer.ex` - Bounds checking
- `test/term_ui/backend/raw_test.exs` - New tests, helper function

## Verification

1. `mix compile` - no warnings
2. `mix test test/term_ui/backend/raw_test.exs` - all tests pass
3. `mix format --check-formatted` - code formatted
