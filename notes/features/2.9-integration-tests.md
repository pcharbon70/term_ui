# Feature: Section 2.9 - Integration Tests

**Branch:** `feature/2.9-integration-tests`
**Base:** `multi-renderer`
**Date:** 2025-12-05
**Status:** In Progress

## Overview

Section 2.9 adds integration tests to verify the Raw backend works correctly in realistic scenarios, including interaction with existing TermUI components.

## Requirements

### Task 2.9.1: Full Lifecycle Tests
- 2.9.1.1 Test init → draw_cells → poll_event → shutdown sequence
- 2.9.1.2 Test alternate screen is properly entered and exited
- 2.9.1.3 Test terminal state is properly restored after shutdown
- 2.9.1.4 Test shutdown after error during rendering

### Task 2.9.2: Renderer Integration Tests
- 2.9.2.1 Test draw_cells/2 with cells from TermUI.Renderer.Buffer
- 2.9.2.2 Test draw_cells/2 with diff operations from TermUI.Renderer.Diff
- 2.9.2.3 Test style rendering matches TermUI.Renderer.Style expectations
- 2.9.2.4 Test cell rendering matches TermUI.Renderer.Cell format

### Task 2.9.3: Input Integration Tests (tagged :requires_terminal)
- 2.9.3.1 Test keyboard input produces correct Event.Key structs
- 2.9.3.2 Test mouse input produces correct Event.Mouse structs
- 2.9.3.3 Test escape sequence handling with timeout disambiguation
- 2.9.3.4 Test input handling after resize event

### Task 2.9.4: Performance Tests
- 2.9.4.1 Measure time to render full 80x24 screen
- 2.9.4.2 Measure time to render differential update (10% changed cells)
- 2.9.4.3 Verify output batching reduces write syscalls
- 2.9.4.4 Verify style delta tracking reduces escape sequence bytes

## Implementation Plan

### 1. Full Lifecycle Tests (2.9.1)

These tests verify the complete backend lifecycle:

```elixir
describe "full lifecycle integration" do
  test "init → draw_cells → shutdown sequence" do
    {:ok, state} = Raw.init(size: {24, 80})
    cells = [Cell.new(0, 0, "X")]
    {:ok, state} = Raw.draw_cells(state, cells)
    {:ok, _state} = Raw.shutdown(state)
  end
end
```

### 2. Renderer Integration Tests (2.9.2)

Test integration with existing renderer modules:
- Create cells using `Cell.new/4`
- Apply styles using `Style` module patterns
- Verify Buffer and Diff compatibility

### 3. Input Integration Tests (2.9.3)

Tagged with `:requires_terminal` since they need actual terminal:
- Test poll_event with simulated input
- Verify event structure correctness

### 4. Performance Tests (2.9.4)

Performance benchmarks:
- Full screen render time
- Differential update time
- Output size measurements

## Files to Create/Modify

| File | Changes |
|------|---------|
| `test/term_ui/backend/raw_integration_test.exs` | New file - integration tests |
| `notes/planning/multi-renderer/phase-02-raw-backend.md` | Mark Section 2.9 complete |

## Verification

```bash
mix test test/term_ui/backend/raw_integration_test.exs
```
