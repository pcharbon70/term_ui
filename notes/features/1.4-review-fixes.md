# Feature: Section 1.4 Review Fixes and Improvements

## Overview

Address concerns and implement suggestions from the Section 1.4 code review to improve validation strictness and code quality.

## Reference

- Review document: `notes/reviews/section-1.4-config-module-review.md`
- Files to modify: `lib/term_ui/backend/config.ex`, `test/term_ui/backend/config_test.exs`

## Concerns to Fix

### Concern 1: Incomplete Keyword List Validation (Priority 1)

**Issue:** Validation uses `is_list/1` which allows regular lists, not just keyword lists.

**Location:** `config.ex:364-390` (validate_tty_opts!/0 and validate_raw_opts!/0)

**Fix:** Replace `is_list/1` with `Keyword.keyword?/1`

```elixir
# Current
unless is_list(opts) do

# Fixed
unless Keyword.keyword?(opts) do
```

### Concern 2: Inconsistent Validation Depth (Priority 2)

**Issue:** `validate_raw_opts!/0` only checks if it's a list, but doesn't validate `alternate_screen` boolean type.

**Location:** `config.ex:383-390`

**Fix:** Add validation for `alternate_screen` boolean type

```elixir
defp validate_raw_opts! do
  opts = get_raw_opts()

  unless Keyword.keyword?(opts) do
    raise ArgumentError, "..."
  end

  if Keyword.has_key?(opts, :alternate_screen) do
    alt = Keyword.get(opts, :alternate_screen)
    unless is_boolean(alt) do
      raise ArgumentError,
        "invalid :alternate_screen value in :raw_opts: #{inspect(alt)}, expected boolean"
    end
  end
end
```

## Suggestions to Implement

### Suggestion 1: Add Custom Type for Runtime Config (Priority 3)

Add a custom `@type config` for the runtime config map for better Dialyzer support.

```elixir
@typedoc """
Complete runtime configuration map.
"""
@type config :: %{
  backend: :auto | module(),
  character_set: :unicode | :ascii,
  fallback_character_set: :unicode | :ascii,
  tty_opts: keyword(),
  raw_opts: keyword()
}

@spec runtime_config() :: config()
```

### Suggestion 2: Add Specs to Private Validation Functions (Priority 3)

Add `@spec` declarations to private helper functions for better Dialyzer coverage.

```elixir
@spec validate_backend!() :: :ok
defp validate_backend! do
  # ...
end
```

## Testing Strategy

- Add tests for non-keyword list rejection (e.g., `[1, 2, 3]`)
- Add tests for invalid `alternate_screen` values (e.g., `:maybe`, `"true"`)
- Ensure existing tests continue to pass

## Files Modified

- `lib/term_ui/backend/config.ex` - Fix validations and add types/specs
- `test/term_ui/backend/config_test.exs` - Add new test cases
