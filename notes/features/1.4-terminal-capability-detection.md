# Feature 1.4: Terminal Capability Detection

## Problem Statement

TermUI needs to detect terminal capabilities to enable graceful degradation and optimal feature utilization. Without capability detection, the framework would either fail on limited terminals or underutilize advanced features on capable ones.

### Impact
- Enables graceful degradation on limited terminals
- Maximizes feature utilization on capable terminals
- Required for color mode selection (true-color, 256, 16, mono)
- Required for mouse tracking and special mode support
- Foundation for rendering engine optimization in Phase 2

## Solution Overview

Implement a multi-method capability detection system that queries:
1. Environment variables ($TERM, $COLORTERM, $TERM_PROGRAM, $LANG)
2. Terminfo database via `infocmp` command
3. Direct terminal queries with timeout handling

Results are cached in ETS for fast concurrent access with automatic fallback chains.

### Key Design Decisions
1. **ETS-based caching** - Fast concurrent access from multiple processes
2. **Multiple detection methods** - Environment → terminfo → direct queries
3. **Conservative fallbacks** - Default to VT100 baseline when uncertain
4. **Automatic degradation** - Transparent to application code

## Technical Details

### Module Structure
```
lib/term_ui/
├── capabilities.ex           # Main capability detection module
└── capabilities/
    ├── detector.ex           # Detection methods implementation
    └── fallbacks.ex          # Graceful degradation utilities
```

### Capability Struct Fields
- `color_mode` - `:true_color`, `:color_256`, `:color_16`, `:monochrome`
- `max_colors` - Integer count of supported colors
- `unicode` - Boolean for UTF-8/Unicode support
- `mouse` - Boolean for mouse tracking support
- `bracketed_paste` - Boolean for bracketed paste mode
- `focus_events` - Boolean for focus event reporting
- `alternate_screen` - Boolean for alternate screen buffer
- `terminal_type` - String from $TERM
- `terminal_program` - String from $TERM_PROGRAM

### Detection Priority
1. $COLORTERM (most reliable for true-color)
2. $TERM_PROGRAM (known terminal emulators)
3. $TERM suffix analysis (256color, truecolor)
4. Terminfo max_colors
5. Conservative VT100 fallback

## Success Criteria

1. ✅ Environment variable parsing extracts correct hints
2. ✅ Terminfo query via `infocmp` works on systems with terminfo
3. ✅ Fallback to VT100 when terminfo unavailable
4. ✅ ETS caching provides fast concurrent access
5. ✅ Color approximation produces visually similar results
6. ✅ Character fallback works for box-drawing
7. ✅ Comprehensive test coverage

## Implementation Plan

### Phase 1: Capability Struct and ETS Registry (1.4.4)
- [ ] Define Capabilities struct with all fields
- [ ] Set up ETS table for caching
- [ ] Implement basic accessors (supports_true_color?, etc.)
- [ ] Implement detect_capabilities/0 orchestrating all detection

### Phase 2: Environment Variable Detection (1.4.1)
- [ ] Parse $TERM for terminal type and color hints
- [ ] Parse $COLORTERM for true-color support
- [ ] Parse $TERM_PROGRAM for known emulators
- [ ] Parse $LC_ALL/$LANG for Unicode support

### Phase 3: Terminfo Query (1.4.2)
- [ ] Implement `infocmp` command execution and parsing
- [ ] Extract max_colors capability
- [ ] Implement fallback when terminfo unavailable
- [ ] Handle various terminfo output formats

### Phase 4: Graceful Degradation (1.4.5)
- [ ] Implement RGB to 256-color approximation
- [ ] Implement 256 to 16-color approximation
- [ ] Implement box-drawing character fallbacks
- [ ] Implement capability-aware API

### Phase 5: Testing
- [ ] Test environment variable parsing
- [ ] Test terminfo query and fallback
- [ ] Test color approximation accuracy
- [ ] Test ETS caching behavior
- [ ] Test concurrent access

## Known Terminal Capabilities

### True-color Support
- iTerm2, Kitty, Alacritty, WezTerm, Windows Terminal
- $COLORTERM="truecolor" or "24bit"
- $TERM containing "truecolor" or "24bit"

### 256-color Support
- Most modern terminals
- $TERM ending in "256color"
- terminfo max_colors >= 256

### Known Terminal Programs
- `iTerm.app` - True-color, mouse, Unicode
- `Apple_Terminal` - 256-color, limited mouse
- `vscode` - True-color, mouse, Unicode
- `tmux` - Depends on outer terminal

## Color Approximation Algorithm

### RGB to 256-color
1. Check exact match in 216-color cube (16-231)
2. Check grayscale ramp (232-255)
3. Calculate nearest color by Euclidean distance

### 256-color to 16-color
Map to nearest ANSI color based on hue/saturation/lightness.

## Notes/Considerations

### Platform Differences
- Linux: terminfo in /usr/share/terminfo or /lib/terminfo
- macOS: terminfo in /usr/share/terminfo
- Windows: No terminfo, rely on environment and defaults

### Edge Cases
- Running in non-terminal (pipes, tests) - detect via `:io.columns/0`
- tmux/screen - Check $TERM_PROGRAM and inner/outer terminal
- SSH sessions - May have different capabilities than local

### Dynamic Capability Queries
Direct terminal queries (1.4.3) are deferred for initial implementation:
- Requires raw mode to read responses
- Timeout handling complexity
- Most capabilities detectable via environment/terminfo

## Current Status

**Status**: Planning Complete - Ready for Implementation

### What Works
- N/A - Implementation not started

### What's Next
- Define Capabilities struct
- Set up ETS caching
- Implement environment variable detection

### How to Run
```bash
cd /home/ducky/code/term_ui
mix test test/term_ui/capabilities_test.exs
```
