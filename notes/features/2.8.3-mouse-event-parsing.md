# Feature: Task 2.8.3 - Implement Mouse Event Parsing

**Branch:** `feature/2.8.3-mouse-event-parsing`
**Base:** `multi-renderer`
**Date:** 2025-12-05
**Status:** Complete (Documentation + Tests)

## Overview

Task 2.8.3 requires implementing mouse event parsing in `poll_event/2`. Analysis shows this is **already implemented** via `EscapeParser` which handles SGR mouse sequences.

## Requirement Analysis

### Task 2.8.3 Subtasks

| Subtask | Requirement | Implementation Location |
|---------|-------------|------------------------|
| 2.8.3.1 | Detect SGR mouse sequence prefix `\e[<` | `parse_csi_sequence/1` line 219 |
| 2.8.3.2 | Parse button, column, row from sequence | `parse_sgr_mouse/1`, `parse_mouse_params/1` lines 260-320 |
| 2.8.3.3 | Decode button to `:left`, `:middle`, `:right`, `:scroll_up`, `:scroll_down` | `decode_button/1` lines 368-371, `decode_mouse_event/4` lines 332-353 |
| 2.8.3.4 | Decode modifiers from button byte (Shift, Alt, Ctrl) | `decode_mouse_event/4` lines 355-359 |
| 2.8.3.5 | Construct `Event.Mouse` with action, button, position, modifiers | `decode_mouse_event/4` line 365 |

## Implementation Details

### SGR Mouse Sequence Detection (2.8.3.1)

```elixir
# lib/term_ui/terminal/escape_parser.ex:219-220
defp parse_csi_sequence(<<"<", rest::binary>>) do
  parse_sgr_mouse(rest)
end
```

### Sequence Parsing (2.8.3.2)

The `parse_sgr_mouse/1` function:
1. Finds terminator (`M` for press, `m` for release) via `find_mouse_terminator/1`
2. Parses parameters via `parse_mouse_params/1` splitting on `;`
3. Extracts `{button_byte, column, row}`

### Button Decoding (2.8.3.3)

```elixir
# Lower 2 bits determine button
defp decode_button(0), do: :left
defp decode_button(1), do: :middle
defp decode_button(2), do: :right
defp decode_button(_), do: nil

# Bit 6 (64) indicates scroll
is_scroll = (cb &&& 64) != 0
# Scroll up: bit 6 + button 0
# Scroll down: bit 6 + button 1
```

### Modifier Decoding (2.8.3.4)

```elixir
# Bits 2-4 encode modifiers
modifiers = if (cb &&& 4) != 0, do: [:shift | modifiers], else: modifiers
modifiers = if (cb &&& 8) != 0, do: [:alt | modifiers], else: modifiers
modifiers = if (cb &&& 16) != 0, do: [:ctrl | modifiers], else: modifiers
```

### Event Construction (2.8.3.5)

```elixir
# Convert 1-indexed terminal coords to 0-indexed
x = cx - 1
y = cy - 1

Event.mouse(action, button, x, y, modifiers: modifiers)
```

## Action Required

Since the implementation is complete, this task requires:

1. [x] Verify existing implementation meets all subtask requirements
2. [x] Document the implementation (this file)
3. [ ] Add unit tests for mouse event parsing (missing from test suite)
4. [ ] Mark Task 2.8.3 complete in phase plan
5. [ ] Mark Unit Tests 2.8 complete
6. [ ] Write summary

## Tests to Add

The following tests should be added to verify mouse parsing:
- SGR mouse sequence for left button press
- SGR mouse sequence for button release
- Scroll wheel events (up/down)
- Modifier detection (Shift, Alt, Ctrl)
- Coordinate conversion (1-indexed to 0-indexed)

## Files to Modify

| File | Changes |
|------|---------|
| `test/term_ui/backend/raw_test.exs` | Add mouse parsing tests |
| `notes/planning/multi-renderer/phase-02-raw-backend.md` | Mark Task 2.8.3 and Unit Tests 2.8 complete |
| `notes/features/2.8.3-mouse-event-parsing.md` | Created (this file) |

## Verification

```bash
mix test test/term_ui/backend/raw_test.exs
```
