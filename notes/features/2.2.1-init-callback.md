# Feature: Task 2.2.1 - Implement init/1 Callback

## Overview

Implement the `init/1` callback for the Raw backend. This callback sets up the terminal for rendering, assuming raw mode was already activated by the Selector.

## Reference

- Planning document: `notes/planning/multi-renderer/phase-02-raw-backend.md`
- Branch: `feature/2.2.1-init-callback`
- Parent branch: `multi-renderer`

## Tasks

### Task 2.2.1: Implement init/1 Callback

- [x] 2.2.1.1 Implement `@impl true` `init/1` accepting keyword options
- [x] 2.2.1.2 Accept `:alternate_screen` option (default: `true`)
- [x] 2.2.1.3 Accept `:hide_cursor` option (default: `true`)
- [x] 2.2.1.4 Accept `:mouse_tracking` option (default: `:none`)
- [x] 2.2.1.5 Accept `:size` option for explicit dimensions, falling back to query

### Task 2.2.2: Implement Terminal Setup Sequence

- [x] 2.2.2.1 Query terminal size using `:io.columns/0` and `:io.rows/0` if not provided
- [x] 2.2.2.2 Enter alternate screen buffer with `\e[?1049h` if `alternate_screen: true`
- [x] 2.2.2.3 Hide cursor with `\e[?25l` if `hide_cursor: true`
- [x] 2.2.2.4 Enable mouse tracking if requested using appropriate escape sequences
- [x] 2.2.2.5 Clear the screen with `\e[2J\e[1;1H` to start fresh
- [x] 2.2.2.6 Return `{:ok, state}` with initialized state struct

## Implementation Plan

### Phase 1: Option Parsing

1. Define default options:
   - `alternate_screen: true`
   - `hide_cursor: true`
   - `mouse_tracking: :none`
   - `size: nil` (auto-detect)

2. Extract and validate options from keyword list using `Keyword.get/3`

### Phase 2: Size Detection

1. If `:size` option provided and valid `{rows, cols}` tuple, use it
2. Otherwise query using `:io.rows/0` and `:io.columns/0`
3. Fall back to environment variables `LINES` and `COLUMNS`
4. Return error if size cannot be determined

### Phase 3: Terminal Setup Sequence

Order of operations (following Terminal module pattern):
1. Enter alternate screen buffer (if enabled)
2. Hide cursor (if enabled)
3. Enable mouse tracking (if mode != `:none`)
4. Clear screen and home cursor

### Phase 4: Build State

Construct `%Raw{}` state struct with:
- `size`: detected or provided dimensions
- `cursor_visible`: opposite of `hide_cursor` option
- `cursor_position`: `{1, 1}` after clear
- `alternate_screen`: from option
- `mouse_mode`: from option
- `current_style`: `nil` initially

## Files to Modify

- `lib/term_ui/backend/raw.ex` - Implement init/1 callback
- `test/term_ui/backend/raw_test.exs` - Add unit tests for init/1

## Testing Strategy

### Unit Tests to Add

1. Test `init/1` with default options returns `{:ok, state}` with correct defaults
2. Test `init/1` with `alternate_screen: false` sets state correctly
3. Test `init/1` with `hide_cursor: false` sets `cursor_visible: true`
4. Test `init/1` with explicit size option uses provided dimensions
5. Test `init/1` with mouse tracking option sets mouse_mode
6. Test `init/1` validates size option format

### Integration Notes

- Actual terminal I/O cannot be tested in unit tests (no real terminal)
- Terminal operations will be wrapped in try/rescue for error safety
- Tests will verify state struct is built correctly from options

## Error Handling

- Invalid `:size` format: return `{:error, :invalid_size}`
- Size detection failure: return `{:error, :size_detection_failed}`
- Terminal I/O failures during setup: wrapped in try/rescue, log but continue
