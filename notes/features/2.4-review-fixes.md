# Feature: Section 2.4 Review Fixes

**Branch:** `feature/2.4-review-fixes`
**Base:** `multi-renderer`
**Date:** 2025-12-05

## Overview

Address all concerns and implement suggestions from the Section 2.4 (Screen Operations) code review.

## Reference

See `notes/reviews/section-2.4-screen-operations-review.md` for full review details.

## Concerns to Fix

### Concern #1: Terminal Size Detection Duplication
**Status:** Document as future task (not blocking Section 2.4)
- Size detection logic duplicated across Raw, Terminal, Platform modules
- Will add TODO comment noting future extraction to shared module

### Concern #2: No ANSI Output Verification Tests
**Status:** Skip (low priority, state tests provide good confidence)
- Would require IO capture which adds complexity
- Current state-based tests adequately verify behavior

### Concern #3: Environment-Dependent Test Brittleness
**Status:** Skip (low priority, tests adequate for coverage)
- Would require mocking infrastructure
- Current tests handle environment variability gracefully

### Concern #4: Silent Write Failures
- [ ] Add debug logging to `write_to_terminal/1`

### Concern #5: No Practical Upper Bounds on Terminal Size
- [ ] Add `@max_terminal_size` constant
- [ ] Update `get_env_int/1` to validate against max
- [ ] Add tests for bounds validation

## Suggestions to Implement

### Suggestion #1: Add Examples to clear/1 Documentation
- [ ] Add `## Examples` section to `clear/1` @doc

### Suggestion #2: Document size/1 Typespec Rationale
- [ ] Add comment explaining why error case is included (future-proofing)

### Suggestion #3: Refactor get_env_int to Use `with`
- [ ] Rewrite nested `case` as idiomatic `with` expression

### Suggestion #4: Use Test Helper Consistently
- [ ] Replace manual state assertions with `assert_state_unchanged_except/3`
- [ ] Locations to fix:
  - clear/1 "preserves other state fields" test
  - size/1 tests (if applicable)
  - refresh_size/1 "preserves other state fields" test

### Suggestion #5: Extract Environment Test Helper
- [ ] Create `with_terminal_env/3` helper function
- [ ] Replace repeated try/after blocks with helper calls

## Files to Modify

- `lib/term_ui/backend/raw.ex` - Implementation fixes
- `test/term_ui/backend/raw_test.exs` - Test improvements

## Verification

1. `mix compile` - no warnings
2. `mix test test/term_ui/backend/raw_test.exs` - all tests pass
3. `mix format --check-formatted` - code formatted
