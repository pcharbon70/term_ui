# Feature 1.2: ANSI Escape Sequence Generation

## Problem Statement

TermUI needs to generate ANSI escape sequences to control terminal behavior - cursor positioning, colors, screen clearing, and special modes. Without a proper sequence generator, the framework cannot render UI elements or control the terminal display.

### Impact
- Foundation for all visual output in TermUI
- Required for cursor positioning, colors, styling
- Enables efficient terminal I/O through optimization
- Used by Phase 2 (Rendering Engine) and all subsequent phases

## Solution Overview

Implement a comprehensive ANSI escape sequence generator module that produces correct VT100/ANSI X3.64 sequences with optimizations for minimal byte output.

### Key Design Decisions
1. **Pure functions** - Sequence generators return iodata, no side effects
2. **Iodata output** - Use iolists for efficient concatenation
3. **Parameter optimization** - Omit default parameters to reduce bytes
4. **Combined sequences** - Merge multiple SGR attributes into single sequence
5. **Separate module** - `TermUI.ANSI` for all escape sequence generation

## Technical Details

### Module Structure
```
lib/term_ui/
└── ansi.ex              # All escape sequence generation
    ├── Cursor control
    ├── Screen manipulation
    ├── Colors and styles
    ├── Special modes
    └── Optimization helpers
```

### Key Constants
- ESC: `\e` or `\x1b` (0x1B)
- CSI: `\e[` (Control Sequence Introducer)
- SGR: Select Graphic Rendition (colors/styles)

### Escape Sequence Formats
- Cursor position: `ESC[{row};{col}H`
- Cursor movement: `ESC[{n}A/B/C/D`
- Clear screen: `ESC[{mode}J`
- Clear line: `ESC[{mode}K`
- SGR: `ESC[{attr1};{attr2};...m`
- Private modes: `ESC[?{mode}h/l`

## Success Criteria

1. ✅ All cursor control sequences generate correctly
2. ✅ All screen manipulation sequences generate correctly
3. ✅ 16-color, 256-color, and true-color sequences work
4. ✅ All text attributes (bold, italic, etc.) work
5. ✅ Special modes (mouse, paste, focus) sequences work
6. ✅ Parameter omission optimization works
7. ✅ SGR combination optimization works
8. ✅ Comprehensive test coverage

## Implementation Plan

### Phase 1: Cursor Control (1.2.1)
- [ ] Implement `cursor_position(row, col)` - absolute positioning
- [ ] Implement relative movement: `cursor_up/1`, `cursor_down/1`, `cursor_forward/1`, `cursor_back/1`
- [ ] Implement `cursor_show/0` and `cursor_hide/0`
- [ ] Implement `save_cursor/0` and `restore_cursor/0`

### Phase 2: Screen Manipulation (1.2.2)
- [ ] Implement screen clear: `clear_screen/0`, `clear_screen_from_cursor/0`, `clear_screen_to_cursor/0`
- [ ] Implement line clear: `clear_line/0`, `clear_line_from_cursor/0`, `clear_line_to_cursor/0`
- [ ] Implement `set_scroll_region(top, bottom)`
- [ ] Implement `scroll_up(n)` and `scroll_down(n)`

### Phase 3: Colors and Styles (1.2.3)
- [ ] Implement 16-color functions (foreground/background, normal/bright)
- [ ] Implement `color_256(index)` for foreground and background
- [ ] Implement `color_rgb(r, g, b)` for true-color
- [ ] Implement text attributes: bold, dim, italic, underline, blink, reverse, hidden, strikethrough
- [ ] Implement `reset_style/0` and combined style function

### Phase 4: Special Modes (1.2.4)
- [ ] Implement bracketed paste mode enable/disable
- [ ] Implement focus event reporting enable/disable
- [ ] Implement application cursor keys mode enable/disable
- [ ] Implement mouse tracking modes (X10, normal, button, all motion)

### Phase 5: Optimization (1.2.5)
- [ ] Implement parameter omission (n=1 → omit)
- [ ] Implement SGR combination helper
- [ ] Document optimization patterns

### Phase 6: Testing
- [ ] Test all cursor control sequences
- [ ] Test all screen manipulation sequences
- [ ] Test all color modes
- [ ] Test all text attributes
- [ ] Test all special modes
- [ ] Test optimizations

## API Design

### Cursor Control
```elixir
ANSI.cursor_position(5, 10)      # "\e[5;10H"
ANSI.cursor_up(3)                # "\e[3A"
ANSI.cursor_down()               # "\e[B" (n=1 omitted)
ANSI.cursor_show()               # "\e[?25h"
ANSI.save_cursor()               # "\e[s"
```

### Screen Manipulation
```elixir
ANSI.clear_screen()              # "\e[2J"
ANSI.clear_line_from_cursor()    # "\e[K"
ANSI.set_scroll_region(5, 20)    # "\e[5;20r"
ANSI.scroll_up(3)                # "\e[3S"
```

### Colors and Styles
```elixir
ANSI.foreground(:red)            # "\e[31m"
ANSI.background(:blue)           # "\e[44m"
ANSI.foreground_256(196)         # "\e[38;5;196m"
ANSI.foreground_rgb(255, 128, 0) # "\e[38;2;255;128;0m"
ANSI.bold()                      # "\e[1m"
ANSI.reset()                     # "\e[0m"
ANSI.format([:bold, :red])       # "\e[1;31m"
```

### Special Modes
```elixir
ANSI.enable_bracketed_paste()    # "\e[?2004h"
ANSI.enable_mouse_tracking(:all) # "\e[?1003h"
```

## Notes/Considerations

### Color Code Reference
- Basic foreground: 30-37 (black, red, green, yellow, blue, magenta, cyan, white)
- Basic background: 40-47
- Bright foreground: 90-97
- Bright background: 100-107
- 256-color: 38;5;n (fg), 48;5;n (bg)
- True-color: 38;2;r;g;b (fg), 48;2;r;g;b (bg)

### SGR Attribute Codes
- 0: Reset
- 1: Bold, 2: Dim, 3: Italic, 4: Underline
- 5: Blink, 7: Reverse, 8: Hidden, 9: Strikethrough

### Optimization Notes
- Default parameters can be omitted (e.g., `ESC[A` = `ESC[1A`)
- Multiple SGR codes can be combined with semicolons
- Relative movement is often cheaper than absolute for small distances

## Current Status

**Status**: ✅ Implementation Complete

### What Works
- All cursor control sequences (position, movement, visibility)
- All screen manipulation sequences (clear, scroll)
- 16-color, 256-color, and true-color support
- All text attributes (bold, italic, underline, etc.)
- All special modes (mouse, paste, focus)
- Parameter omission optimization
- SGR combination via format/1
- 33 tests passing

### What's Not Implemented
- 1.2.5.2 - Cursor movement optimization (choosing between absolute/relative)
- 1.2.5.4 - Style delta tracking

### How to Run
```bash
cd /home/ducky/code/term_ui
mix test test/term_ui/ansi_test.exs
```
