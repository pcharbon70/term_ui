# Feature: Section 6.12.2 SupervisionTreeViewer Widget

## Problem Statement

OTP supervision trees are fundamental to BEAM application architecture but can be difficult to visualize and debug. While tools like Observer provide GUI-based tree viewing, they require a graphical environment. A terminal-based supervision tree viewer enables developers to inspect and manage supervision hierarchies in remote, headless, or embedded environments.

## Solution Overview

Implement a SupervisionTreeViewer widget that:
- Displays OTP supervision hierarchy as a navigable tree
- Shows live status indicators (running, restarting, terminated)
- Displays restart counts and supervisor strategy
- Provides process state inspection on selection
- Supports restart/terminate actions with confirmation
- Auto-refreshes when supervision tree changes

## Requirements (from Phase 6 Planning)

### 6.12.2 SupervisionTreeViewer Widget

- [x] 6.12.2.1 Implement tree view of supervision hierarchy
- [x] 6.12.2.2 Implement live status indicators (running, restarting, terminated)
- [x] 6.12.2.3 Implement restart count and history display
- [x] 6.12.2.4 Implement supervisor strategy display
- [x] 6.12.2.5 Implement click to inspect child process state
- [x] 6.12.2.6 Implement restart/terminate controls with confirmation
- [x] 6.12.2.7 Implement auto-refresh on supervision tree changes

## Technical Design

### Supervision Node Structure

```elixir
@type sup_node :: %{
  id: term(),
  pid: pid(),
  name: atom() | nil,
  type: :supervisor | :worker,
  status: :running | :restarting | :terminated | :undefined,
  child_spec: map() | nil,
  # Supervisor-specific
  strategy: :one_for_one | :one_for_all | :rest_for_one | :simple_one_for_one | nil,
  restart_count: non_neg_integer(),
  max_restarts: non_neg_integer() | nil,
  max_seconds: non_neg_integer() | nil,
  children: [sup_node()] | nil,
  # Process info
  memory: non_neg_integer(),
  reductions: non_neg_integer(),
  message_queue_len: non_neg_integer()
}
```

### Status Icons

```elixir
@status_icons %{
  running: "‚óè",      # Green
  restarting: "‚óê",   # Yellow
  terminated: "‚óã",   # Red
  undefined: "?"     # Gray
}

@type_icons %{
  supervisor: "üì¶",
  worker: "‚öô"
}
```

### Strategy Display

| Strategy | Display |
|----------|---------|
| one_for_one | "1:1" |
| one_for_all | "1:*" |
| rest_for_one | "1:‚Üí" |
| simple_one_for_one | "1:1+" |

### Keyboard Controls

| Key | Action |
|-----|--------|
| Up/Down | Move selection |
| Left | Collapse or move to parent |
| Right | Expand or move to first child |
| Enter | Toggle expand/collapse |
| i | Show process info panel |
| r | Restart selected process (with confirmation) |
| k | Terminate selected process (with confirmation) |
| R | Refresh tree |
| / | Filter by name |
| Escape | Clear filter/close panel |

## Implementation Plan

### Step 1: Core Structure (6.12.2.1)
- [ ] Create `lib/term_ui/widgets/supervision_tree_viewer.ex`
- [ ] Define types and node structure
- [ ] Implement `new/1` for props creation
- [ ] Implement `init/1` for state initialization
- [ ] Implement tree building using `Supervisor.which_children/1`
- [ ] Recursively traverse supervisor children

### Step 2: Live Status Indicators (6.12.2.2)
- [ ] Fetch process status using `Process.info/2`
- [ ] Color-code by status (green/yellow/red/gray)
- [ ] Display status icon next to each node
- [ ] Handle dead process detection gracefully

### Step 3: Restart Count & History (6.12.2.3)
- [ ] Extract supervisor restart intensity from spec
- [ ] Track restart events (monitor supervisor)
- [ ] Display restart count for supervisors
- [ ] Show max_restarts/max_seconds configuration

### Step 4: Supervisor Strategy Display (6.12.2.4)
- [ ] Extract strategy from supervisor child spec
- [ ] Display strategy abbreviation
- [ ] Show in node info panel

### Step 5: Process State Inspection (6.12.2.5)
- [ ] Implement info panel showing process details
- [ ] Use `:sys.get_state/1` for GenServer state (with timeout)
- [ ] Display current function, initial call
- [ ] Show message queue and memory

### Step 6: Restart/Terminate Controls (6.12.2.6)
- [ ] Implement restart with `Supervisor.restart_child/2`
- [ ] Implement terminate with `Supervisor.terminate_child/2`
- [ ] Add confirmation dialog (y/n)
- [ ] Show action result feedback
- [ ] Prevent actions on critical supervisors (optional protection)

### Step 7: Auto-Refresh (6.12.2.7)
- [ ] Implement configurable refresh interval
- [ ] Monitor supervisor for child changes
- [ ] Refresh on `:DOWN` messages from monitored processes
- [ ] Efficient diff-based updates

### Step 8: Navigation & Rendering
- [ ] Integrate with TreeView patterns (expand/collapse)
- [ ] Implement keyboard navigation
- [ ] Render tree with indentation
- [ ] Highlight selected node
- [ ] Show filter input when active

### Step 9: Public API
- [ ] `refresh/1` - Force refresh
- [ ] `set_root/2` - Set root supervisor
- [ ] `get_selected/1` - Get selected node
- [ ] `expand_all/1` - Expand all nodes
- [ ] `collapse_all/1` - Collapse all nodes

### Step 10: Tests
- [ ] Test tree building from supervisor
- [ ] Test status indicator display
- [ ] Test navigation (up/down/left/right)
- [ ] Test expand/collapse
- [ ] Test restart/terminate actions
- [ ] Test filtering
- [ ] Test auto-refresh

### Step 11: Example Application
- [ ] Create `examples/supervision_tree_viewer/` directory
- [ ] Create sample supervision tree with workers
- [ ] Demonstrate tree navigation
- [ ] Show process inspection
- [ ] Demo restart/terminate actions

## API Usage

### Fetching Supervision Tree

```elixir
# Get children of a supervisor
children = Supervisor.which_children(supervisor_pid)
# Returns: [{id, child_pid | :restarting | :undefined, type, modules}]

# Get supervisor spec info
{:ok, {sup_flags, _child_specs}} = :supervisor.get_childspec(supervisor_pid, child_id)
# sup_flags contains :strategy, :intensity, :period
```

### Process Inspection

```elixir
# Get process state (GenServer)
:sys.get_state(pid, 5000)  # 5 second timeout

# Get process info
Process.info(pid, [:status, :memory, :reductions, :message_queue_len, :current_function])
```

## Success Criteria

- [ ] SupervisionTreeViewer displays live supervision tree
- [ ] Status indicators reflect actual process status
- [ ] Restart counts are accurate
- [ ] Supervisor strategies are displayed correctly
- [ ] Process inspection shows useful state info
- [ ] Restart/terminate actions work with confirmation
- [ ] Auto-refresh captures tree changes
- [ ] All tests pass
- [ ] Example application demonstrates features

## Current Status

**Status**: COMPLETED

**What Works**:
- SupervisionTreeViewer widget fully implemented
- All 7 requirements from Phase 6 planning met
- 43 comprehensive tests passing
- Example application with sample supervision tree

**Files Created**:
- `lib/term_ui/widgets/supervision_tree_viewer.ex` (~1000 lines)
- `test/term_ui/widgets/supervision_tree_viewer_test.exs` (43 tests)
- `examples/supervision_tree_viewer/` (example application)
- `notes/features/6.12.2-supervisiontreeviewer-widget.md` (this document)
- `notes/summaries/6.12.2-supervisiontreeviewer-widget-summary.md`

**Test Coverage**:
- 43 tests covering all features
- Props and initialization
- Navigation (up/down/left/right/page/home/end)
- Expand/collapse functionality
- Info panel toggle
- Filtering (input, apply, clear, backspace)
- Process actions (restart, terminate with confirmation)
- Refresh and timer
- Public API functions
- Callbacks (on_select, on_action)
- Rendering
