# Feature: Section 6.10.1 TreeView Widget

## Problem Statement

Applications need to display hierarchical data (file systems, organizational structures, nested configurations) with interactive expand/collapse functionality. TermUI currently lacks a widget for this common UI pattern.

## Solution Overview

Implement a TreeView widget that renders hierarchical data with:
- Indented tree structure with expand/collapse
- Lazy loading support for large/dynamic trees
- Rich keyboard navigation
- Single and multi-select modes
- Search/filter capabilities
- Custom node icons

## Requirements (from Phase 6 Planning)

### 6.10.1 TreeView Widget

- [x] 6.10.1.1 Define tree node structure with children and metadata
- [x] 6.10.1.2 Implement tree rendering with indentation
- [x] 6.10.1.3 Implement expand/collapse with persistence
- [x] 6.10.1.4 Implement lazy loading of children (on_expand callback)
- [x] 6.10.1.5 Implement keyboard navigation (arrows, Enter to toggle)
- [x] 6.10.1.6 Implement multi-select with Shift/Ctrl modifiers
- [x] 6.10.1.7 Implement search/filter with path highlighting
- [x] 6.10.1.8 Implement custom node icons

## Technical Design

### Node Structure

```elixir
%{
  id: term(),                    # Unique identifier
  label: String.t(),             # Display text
  icon: String.t() | nil,        # Optional icon (e.g., "üìÅ", "üìÑ")
  children: [node()] | :lazy,    # Child nodes or :lazy for on-demand loading
  expanded: boolean(),           # Current expand state (optional, defaults to false)
  selected: boolean(),           # Selection state (optional)
  disabled: boolean(),           # Whether node is disabled (optional)
  metadata: map()                # User-defined data (optional)
}
```

### Props

```elixir
TreeView.new(
  nodes: [node()],               # Root nodes
  on_select: fn node -> ... end, # Selection callback
  on_expand: fn node -> ... end, # Expand callback (for lazy loading)
  on_collapse: fn node -> ... end,
  selection_mode: :single | :multi | :none,
  show_root: boolean(),          # Show root node or start from children
  indent_size: integer(),        # Characters per indent level (default: 2)
  icons: %{                      # Default icons
    expanded: "‚ñº",
    collapsed: "‚ñ∂",
    leaf: " ",
    loading: "‚ü≥"
  }
)
```

### State

```elixir
%{
  nodes: [node()],
  flat_nodes: [{node, depth, path}],  # Flattened visible nodes
  cursor: integer(),                   # Current cursor position
  selected: MapSet.t(id),             # Selected node IDs
  expanded: MapSet.t(id),             # Expanded node IDs
  loading: MapSet.t(id),              # Nodes currently loading children
  filter: String.t() | nil,           # Current search filter
  selection_mode: atom(),
  ...
}
```

### Keyboard Navigation

| Key | Action |
|-----|--------|
| Up/Down | Move cursor |
| Left | Collapse node or move to parent |
| Right | Expand node or move to first child |
| Enter/Space | Toggle expand or select |
| Home/End | Jump to first/last visible node |
| PageUp/PageDown | Jump by visible page |
| Ctrl+A | Select all (multi-select mode) |
| Shift+Up/Down | Extend selection (multi-select mode) |
| / | Start search filter |
| Escape | Clear filter or deselect |

### Rendering

```
‚ñº Root                    # expanded, depth 0
  ‚ñ∂ Folder 1              # collapsed, depth 1
  ‚ñº Folder 2              # expanded, depth 1
    ‚ñ∂ Subfolder           # collapsed, depth 2
      File 1.txt          # leaf, depth 2
      File 2.txt          # leaf, depth 2
  ‚ü≥ Loading...            # loading indicator
```

## Implementation Plan

### Step 1: Core Structure (6.10.1.1)
- [x] Create `lib/term_ui/widgets/tree_view.ex`
- [x] Define node type and helper functions
- [x] Implement `new/1` for props creation
- [x] Implement `init/1` for state initialization

### Step 2: Basic Rendering (6.10.1.2)
- [x] Implement node flattening (visible nodes only)
- [x] Implement `render/2` with indentation
- [x] Implement expand/collapse indicators
- [x] Implement cursor highlighting

### Step 3: Expand/Collapse (6.10.1.3)
- [x] Implement expand state in MapSet
- [x] Implement toggle on Enter/Space
- [x] Implement Left to collapse, Right to expand
- [x] Persist expand state across re-renders

### Step 4: Keyboard Navigation (6.10.1.5)
- [x] Implement Up/Down cursor movement
- [x] Implement Left/Right for collapse/expand/parent/child
- [x] Implement Home/End for first/last
- [x] Implement PageUp/PageDown for page jumps

### Step 5: Lazy Loading (6.10.1.4)
- [x] Detect `:lazy` children marker
- [x] Call `on_expand` callback when expanding lazy node
- [x] Show loading indicator while loading
- [x] Update children when loaded via `set_children/3`

### Step 6: Selection (6.10.1.6)
- [x] Implement single selection mode
- [x] Implement multi-select with Ctrl+click equivalent (Space)
- [x] Implement range select with Shift+Up/Down
- [x] Implement Select All with Ctrl+A
- [x] Call `on_select` callback on selection change

### Step 7: Search/Filter (6.10.1.7)
- [x] Implement filter state
- [x] Filter visible nodes by label match
- [x] Auto-expand parents of matching nodes
- [x] Highlight matching text in labels

### Step 8: Custom Icons (6.10.1.8)
- [x] Support per-node icon override
- [x] Support icon configuration in props
- [x] Render icons before labels

### Step 9: Tests
- [x] Test node rendering with correct indentation
- [x] Test expand/collapse updates visible nodes
- [x] Test keyboard navigation
- [x] Test lazy loading calls callback
- [x] Test selection modes
- [x] Test search filter

### Step 10: Example Application
- [x] Create `examples/tree_view/` directory
- [x] Implement file system tree demo
- [x] Show lazy loading with simulated delay

## Success Criteria

- [x] TreeView renders hierarchical nodes with correct indentation
- [x] Expand/collapse works with keyboard and persists
- [x] Lazy loading calls on_expand and shows loading state
- [x] All navigation keys work as documented
- [x] Multi-select with Shift modifier works
- [x] Search filter shows matching nodes
- [x] Custom icons display correctly
- [x] All tests pass (65 tests)
- [x] Example application demonstrates features

## Current Status

**Status**: COMPLETED

**What Works**:
- TreeView widget fully implemented
- All 8 requirements from Phase 6 planning met
- 65 comprehensive tests passing
- Example application demonstrating file browser

**Files Created**:
- `lib/term_ui/widgets/tree_view.ex` (~870 lines)
- `test/term_ui/widgets/tree_view_test.exs` (65 tests)
- `examples/tree_view/` (example application)
- `notes/summaries/6.10.1-treeview-widget-summary.md`

**Test Coverage**:
- 65 tests covering all features
- Node constructors, initialization, rendering
- Keyboard navigation, expand/collapse
- Single and multi selection
- Filtering with path highlighting
- Lazy loading
- Public API functions
- Edge cases
