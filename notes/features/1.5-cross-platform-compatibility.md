# Feature 1.5: Cross-Platform Compatibility

## Problem Statement

TermUI needs to work correctly on Linux, macOS, and Windows 10+. While Linux and macOS share POSIX terminal semantics, Windows has different APIs. Without a platform abstraction layer, code would be littered with platform conditionals.

### Impact
- Enables TermUI to run on all major platforms
- Provides unified API hiding platform differences
- Foundation for all terminal operations across platforms
- Required for Phase 2 rendering and Phase 5 event handling

## Solution Overview

Implement a platform abstraction layer using Elixir behaviours with platform-specific implementations. Detection at startup selects the appropriate implementation automatically.

### Key Design Decisions
1. **Behaviour pattern** - Define interface, implement per-platform
2. **Runtime detection** - Use `:os.type()` for platform identification
3. **WSL detection** - Check for /proc/version containing "Microsoft"
4. **Unix-first focus** - Full Unix implementation, Windows stubs for now

### Scope Note
Windows terminal handling (1.5.3) requires NIFs or ports to call Win32 APIs (SetConsoleMode, etc.). Since TermUI is currently Unix-focused and Windows requires additional native code, we implement:
- Full platform detection
- Complete Unix implementation
- Windows stubs with clear error messages
- Architecture ready for future Windows support

## Technical Details

### Module Structure
```
lib/term_ui/
├── platform.ex               # Platform detection and routing
└── platform/
    ├── unix.ex               # Unix (Linux/macOS) implementation
    └── windows.ex            # Windows stubs (future implementation)
```

### Platform Behaviour Callbacks
- `platform/0` - Return platform atom
- `os_version/0` - Return version tuple
- `terminal_size/0` - Get terminal dimensions
- `supports_feature?/1` - Check platform feature support

### Detection Logic
1. Call `:os.type()` to get `{:unix, _}` or `{:win32, _}`
2. For Unix, check system for Linux vs macOS vs FreeBSD
3. Check WSL via /proc/version
4. Select implementation module based on detection

## Success Criteria

1. ✅ Platform detection returns correct identifier
2. ✅ OS version parsing works across formats
3. ✅ WSL detection distinguishes from native Linux
4. ✅ Unix implementation provides full functionality
5. ✅ Windows stubs provide clear error messages
6. ✅ Behaviour pattern allows easy extension
7. ✅ Comprehensive test coverage

## Implementation Plan

### Phase 1: Platform Detection (1.5.1)
- [ ] Implement platform/0 using :os.type()
- [ ] Implement os_version/0 parsing version strings
- [ ] Implement wsl?/0 checking /proc/version
- [ ] Implement unix?/0 and windows?/0 helpers

### Phase 2: Platform Behaviour (1.5.4)
- [ ] Define TermUI.Platform behaviour with callbacks
- [ ] Implement automatic platform selection
- [ ] Create platform routing functions

### Phase 3: Unix Implementation (1.5.2)
- [ ] Implement Unix module with behaviour callbacks
- [ ] Terminal size via :io.columns/rows
- [ ] Platform-specific capability hints

### Phase 4: Windows Stubs (1.5.3)
- [ ] Implement Windows module with stubs
- [ ] Clear error messages for unsupported operations
- [ ] Document future implementation needs

### Phase 5: Testing
- [ ] Test platform detection
- [ ] Test OS version parsing
- [ ] Test WSL detection
- [ ] Test Unix functionality
- [ ] Test Windows error handling

## Platform-Specific Details

### Linux
- Full POSIX terminal support
- Terminfo in /usr/share/terminfo or /lib/terminfo
- SIGWINCH for resize events

### macOS
- Similar to Linux but some differences
- Terminfo in /usr/share/terminfo
- Terminal.app vs iTerm2 capability differences

### Windows 10+
- Requires VT sequence support (build 1511+)
- SetConsoleMode with ENABLE_VIRTUAL_TERMINAL_PROCESSING
- ConPTY for full support
- No native SIGWINCH, use console events

### WSL (Windows Subsystem for Linux)
- Presents as Linux but running on Windows
- Has some Windows-specific limitations
- Detected via /proc/version containing "Microsoft" or "WSL"

## Notes/Considerations

### Future Windows Implementation
Full Windows support would require:
- NIF or port for Win32 API calls
- SetConsoleMode wrapper
- Console event handling
- GetConsoleScreenBufferInfo for size

### Testing Limitations
- Platform-specific tests only run on that platform
- WSL tests need WSL environment
- CI matrix should cover Linux/macOS/Windows

## Current Status

**Status**: Planning Complete - Ready for Implementation

### What Works
- N/A - Implementation not started

### What's Next
- Create platform detection module
- Define behaviour
- Implement Unix module

### How to Run
```bash
cd /home/ducky/code/term_ui
mix test test/term_ui/platform_test.exs
```
