# Feature Plan: Section 7.2 - Mouse Input Support

## Problem Statement

TermUI applications can now receive keyboard input (7.1), but mouse support is missing. Modern TUI applications benefit from mouse interaction for clicking buttons, selecting items, scrolling, and dragging. Without mouse support:
- Users must rely solely on keyboard navigation
- Applications cannot implement common UI patterns like clickable buttons
- Scrolling requires manual key presses instead of natural scroll wheel

**Impact:** Adding mouse support significantly improves usability and enables richer interaction patterns in TUI applications.

## Solution Overview

Implement complete mouse input pipeline:

```
Terminal → Enable mouse mode → EscapeParser → Event.Mouse → Runtime → dispatch
```

### Key Design Decisions

1. **SGR Extended Mode** - Use SGR (ESC[<...) encoding for accurate coordinates beyond 223
2. **Multiple Tracking Modes** - Support click-only, drag, and all-motion modes
3. **Extend EscapeParser** - Add mouse sequence parsing to existing parser
4. **Use Existing Event.Mouse** - Leverage the struct already defined in Phase 5.1

### Architecture

```
┌─────────┐     ┌──────────────┐     ┌─────────────┐     ┌─────────┐
│Terminal │ ──> │ InputReader  │ ──> │EscapeParser │ ──> │ Runtime │
│(mouse   │     │              │     │(+mouse      │     │         │
│ mode)   │     │              │     │ parsing)    │     │         │
└─────────┘     └──────────────┘     └─────────────┘     └─────────┘
```

## Technical Details

### File Structure

```
lib/term_ui/
├── terminal.ex              # Add mouse mode enable/disable
└── terminal/
    └── escape_parser.ex     # Add SGR mouse sequence parsing
```

### Mouse Mode Escape Sequences

| Mode | Enable | Disable | Description |
|------|--------|---------|-------------|
| Basic click | ESC[?1000h | ESC[?1000l | Report button press/release |
| Button event | ESC[?1002h | ESC[?1002l | Also report drag motion |
| Any event | ESC[?1003h | ESC[?1003l | Report all mouse motion |
| SGR extended | ESC[?1006h | ESC[?1006l | Extended coordinate format |

### SGR Mouse Event Format

Format: `ESC [ < Cb ; Cx ; Cy M` (press) or `ESC [ < Cb ; Cx ; Cy m` (release)

Where:
- `Cb` = button code with modifier flags
- `Cx` = column (1-indexed)
- `Cy` = row (1-indexed)
- `M` = press, `m` = release

Button codes:
- 0 = left button
- 1 = middle button
- 2 = right button
- 64 = scroll up
- 65 = scroll down
- Add 32 for motion events (drag)

Modifier flags (added to button code):
- 4 = Shift
- 8 = Alt/Meta
- 16 = Ctrl

### Dependencies

- `TermUI.Event.Mouse` - Event struct (already exists)
- `TermUI.Terminal` - Add mouse mode functions
- `TermUI.Terminal.EscapeParser` - Add mouse parsing
- `TermUI.Runtime` - Already dispatches Event.Mouse

## Implementation Plan

### Task 7.2.1: Mouse Mode Activation ✅

- [x] 7.2.1.1 Add `enable_mouse_tracking/1` to Terminal with mode parameter
- [x] 7.2.1.2 Add `disable_mouse_tracking/0` to Terminal
- [x] 7.2.1.3 Implement GenServer handlers for mouse mode calls
- [x] 7.2.1.4 Track mouse_tracking state in Terminal.State
- [x] 7.2.1.5 Include mouse tracking disable in Terminal.restore/0

### Task 7.2.2: Mouse Event Parsing ✅

- [x] 7.2.2.1 Add SGR mouse sequence pattern to EscapeParser
- [x] 7.2.2.2 Parse button code, coordinates from SGR format
- [x] 7.2.2.3 Decode button field into button atom and modifiers list
- [x] 7.2.2.4 Determine action type (press, release, drag, scroll)
- [x] 7.2.2.5 Convert 1-indexed terminal coords to 0-indexed
- [x] 7.2.2.6 Create Event.Mouse struct with all fields

### Task 7.2.3: Runtime Mouse Dispatch ✅

- [x] 7.2.3.1 Enable mouse tracking in Runtime.init when terminal available
- [x] 7.2.3.2 Disable mouse tracking in Runtime.terminate
- [x] 7.2.3.3 Verify dispatch_event handles Event.Mouse correctly
- [ ] 7.2.3.4 Add mouse_enabled field to Runtime.State (optional tracking)

### Unit Tests ✅

- [x] Test enable_mouse_tracking sends correct escape sequences
- [x] Test disable_mouse_tracking sends disable sequences
- [x] Test SGR mouse press event parsing (left, middle, right)
- [x] Test SGR mouse release event parsing
- [x] Test scroll wheel event parsing (up/down)
- [x] Test drag event parsing
- [x] Test modifier detection (Shift, Alt, Ctrl)
- [x] Test coordinate conversion (1-indexed to 0-indexed)
- [x] Test mouse event dispatch through Runtime

## Success Criteria

1. Terminal.enable_mouse_tracking(:click) enables basic mouse reporting
2. Terminal.enable_mouse_tracking(:drag) enables button event tracking
3. Terminal.enable_mouse_tracking(:all) enables all motion tracking
4. Mouse clicks create Event.Mouse with correct button, coordinates, modifiers
5. Scroll wheel creates Event.Mouse with :scroll_up/:scroll_down action
6. Mouse events route through Runtime to components
7. Terminal.restore disables mouse tracking
8. All existing tests continue to pass
9. New unit tests pass

## Current Status

- **Planning**: Complete
- **Implementation**: Complete
- **Tests**: Complete (18 tests passing)

## Notes/Considerations

- SGR mode (1006) must be enabled alongside tracking mode (1000/1002/1003)
- Some older terminals don't support SGR; could add legacy X10 mode fallback later
- Motion events (:all mode) can generate many events; use judiciously
- Mouse coordinates are 1-indexed from terminal, convert to 0-indexed internally
- Button code has modifiers mixed in; need bitwise operations to extract
