# Feature Plan: Section 7.5 - Graceful Shutdown

## Problem Statement

When a TUI application exits, the terminal must be restored to its original state. Currently:
- Runtime has basic `shutdown/1` and `terminate/2` callbacks
- Terminal has `restore/0` function
- But there's no `:quit` command type for components to request shutdown
- Process cleanup order needs verification
- No tests for shutdown behavior

**Impact:** Without proper graceful shutdown:
- Terminal may be left in raw mode (unusable shell)
- Cursor may be hidden
- Alternate screen may still be active
- Mouse tracking may still be enabled
- Processes may be left running

## Solution Overview

Complete the shutdown pipeline with proper command support and verified cleanup:

```
Component returns :quit command → Runtime processes → cleanup processes → restore terminal → stop
```

### Key Design Decisions

1. **Add :quit command type** - Components can request application exit
2. **Verify terminal restoration** - Cursor, screen, mouse, raw mode all restored
3. **Ordered process cleanup** - InputReader → components → BufferManager → Terminal
4. **Crash resilience** - Cleanup continues even if parts fail

### Architecture

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ Component   │ --> │ Runtime     │ --> │ Process     │ --> │ Terminal    │
│ :quit cmd   │     │ handle_cast │     │ cleanup     │     │ restore     │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

## Technical Details

### File Structure

```
lib/term_ui/
├── command.ex           # Add :quit command type
└── runtime.ex           # Enhance shutdown handling
```

### Dependencies

- `TermUI.Command` - Add `:quit` type
- `TermUI.Runtime` - Handle quit command
- `TermUI.Terminal` - Already has restore/0
- `TermUI.Terminal.InputReader` - Already has stop/1

### Existing Infrastructure

Current shutdown implementation in runtime.ex:
- `shutdown/1` - Public API to initiate shutdown
- `handle_cast(:shutdown, state)` - Calls initiate_shutdown
- `terminate/2` - Stops InputReader, unregisters resize, calls restore
- `initiate_shutdown/1` - Sets flag and calls do_shutdown
- `do_shutdown/1` - Clears pending commands and components

Current Terminal restoration in terminal.ex:
- `restore/0` - Shows cursor, leaves alternate screen, disables raw mode
- `do_restore/1` - Internal function that handles all restoration

## Implementation Plan

### Task 7.5.1: Quit Command Handling ✅

- [x] 7.5.1.1 Add `:quit` command type to Command module
- [x] 7.5.1.2 Handle `:quit` command in Runtime's execute_commands
- [x] 7.5.1.3 Ensure initiate_shutdown is called with optional exit code
- [x] 7.5.1.4 Wait for pending commands with timeout before shutdown
- [x] 7.5.1.5 Stop the Runtime GenServer after cleanup

### Task 7.5.2: Terminal State Restoration ✅

- [x] 7.5.2.1 Verify show cursor (ESC[?25h) is called if hidden
- [x] 7.5.2.2 Verify leave alternate screen (ESC[?1049l) if entered
- [x] 7.5.2.3 Verify mouse tracking disabled if enabled
- [x] 7.5.2.4 Verify raw mode disabled and settings restored
- [x] 7.5.2.5 Add reset terminal attributes (ESC[0m) to restoration
- [x] 7.5.2.6 Ensure trap_exit is set for crash recovery

### Task 7.5.3: Process Cleanup ✅

- [x] 7.5.3.1 Stop InputReader first to stop receiving events
- [x] 7.5.3.2 Clear pending commands with timeout
- [x] 7.5.3.3 Allow BufferManager to clean up
- [x] 7.5.3.4 Call Terminal.restore() for terminal cleanup
- [x] 7.5.3.5 Wrap cleanup in try/rescue for crash resilience

### Unit Tests ✅

- [x] Test quit command triggers shutdown
- [x] Test terminal cursor restored after exit
- [x] Test alternate screen exited after exit
- [x] Test raw mode disabled after exit
- [x] Test mouse tracking disabled after exit
- [x] Test cleanup completes even on crash
- [x] Test all processes stopped after shutdown

## Success Criteria

1. Components can return :quit command to exit application
2. Runtime properly shuts down in response to :quit
3. Terminal is fully restored (cursor, screen, mouse, raw mode)
4. Processes are stopped in correct order
5. Cleanup is resilient to errors
6. All existing tests continue to pass
7. New unit tests pass

## Current Status

- **Planning**: Complete
- **Implementation**: Complete
- **Tests**: Complete (15 tests passing)

## Notes/Considerations

- The Runtime.terminate callback already calls Terminal.restore()
- Need to ensure BufferManager cleanup doesn't cause errors
- Should support optional exit code/reason for quit command
- Consider adding timeout for pending command completion
- trap_exit is already set in Terminal.init, may need in Runtime too
