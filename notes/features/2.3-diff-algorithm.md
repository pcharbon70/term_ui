# Feature Plan: 2.3 Diff Algorithm

## Problem Statement

The rendering engine needs to efficiently identify changes between the current and previous buffers to minimize terminal output. Instead of redrawing the entire screen each frame, we compare buffers cell-by-cell and only emit escape sequences for changed regions. This differential rendering is critical for:

- Responsive performance over SSH or slow connections
- Reduced CPU usage for mostly-static UIs
- Smooth animations without full-screen flicker

We need:
- Cell comparison for visual equality
- Row-based diffing to identify changed regions
- Change span optimization to reduce cursor movements
- Wide character handling to avoid display corruption
- Render operation generation for the escape sequence emitter

## Solution Overview

Implement a Diff module that compares two buffers and produces a list of render operations:

1. **Cell comparison** - Check if two cells are visually identical
2. **Row diffing** - Find changed spans within each row
3. **Span optimization** - Merge small gaps, split on style changes
4. **Wide char handling** - Include both cells of double-width characters
5. **Operation generation** - Produce `{:move, row, col}`, `{:style, style}`, `{:text, string}`

### Key Design Decisions

- **Row-major iteration** - Matches terminal's efficient row output
- **Span-based output** - Group contiguous changes to minimize cursor moves
- **Style delta tracking** - Only emit changed style attributes
- **Early-exit comparison** - Stop comparing on first difference

## Technical Details

### File Structure
```
lib/term_ui/renderer/
├── diff.ex              # NEW: Diff algorithm implementation

test/term_ui/renderer/
├── diff_test.exs        # NEW: Tests for diff algorithm
```

### Dependencies
- Section 2.1: Cell, Buffer modules
- Section 2.2: BufferManager for double buffering

## Implementation Plan

### Task 2.3.1: Cell Comparison ✅
- [x] 2.3.1.1 Implement `Cell.equal?/2` comparing all cell properties
- [x] 2.3.1.2 Optimize for common case (cells equal) with early exit
- [x] 2.3.1.3 Handle color representation differences (named vs RGB that appear same)
- [x] 2.3.1.4 Compare character, fg, bg, and all attributes

### Task 2.3.2: Row-Based Diffing ✅
- [x] 2.3.2.1 Implement `diff_row/4` comparing corresponding rows
- [x] 2.3.2.2 Find change spans (contiguous changed cells)
- [x] 2.3.2.3 Skip unchanged rows entirely
- [x] 2.3.2.4 Track row modification state

### Task 2.3.3: Change Span Optimization ✅
- [x] 2.3.3.1 Calculate span boundaries for minimal output
- [x] 2.3.3.2 Merge adjacent spans when gap < cursor move cost
- [x] 2.3.3.3 Split spans at style changes
- [x] 2.3.3.4 Generate cursor position and styled text for each span

### Task 2.3.4: Wide Character Handling ✅
- [x] 2.3.4.1 Detect wide characters (display width > 1)
- [x] 2.3.4.2 Include both cells of wide character in same span
- [x] 2.3.4.3 Handle overwrite detection (single-width over wide char)
- [x] 2.3.4.4 Clear corrupted wide characters properly

### Task 2.3.5: Diff Output Generation ✅
- [x] 2.3.5.1 Define render operation types: `{:move, row, col}`, `{:style, style}`, `{:text, string}`
- [x] 2.3.5.2 Generate operations from change spans
- [x] 2.3.5.3 Merge adjacent same-style text operations
- [x] 2.3.5.4 Sort operations for optimal cursor movement

### Unit Tests ✅
- [x] Test cell comparison identifies identical and different cells
- [x] Test row diffing finds all changed cells
- [x] Test unchanged rows are skipped
- [x] Test change span detection groups contiguous changes
- [x] Test span merging reduces cursor movements
- [x] Test wide character pairs stay together
- [x] Test diff output generates correct operations
- [x] Test deterministic output for same input

## Success Criteria

1. Cell comparison correctly identifies all visual differences
2. Row diffing finds changed regions efficiently
3. Span optimization reduces cursor movements by merging small gaps
4. Wide characters are handled without display corruption
5. Generated operations are minimal and correct
6. All unit tests pass
7. Credo strict mode passes

## Current Status

**Status**: ✅ Complete

### What Works
- Cell comparison with early-exit optimization
- Row-based diffing with change span detection
- Span optimization with gap merging
- Wide character pair handling
- Render operation generation
- Style delta tracking
- 45 unit tests passing

### What's Next
- Section 2.4: Cursor Optimization

### How to Run
```bash
mix test test/term_ui/renderer/diff_test.exs
mix credo --strict
```

## Notes

- Cell comparison is hot path - optimize for common case (cells equal)
- Span merging threshold based on cursor move cost (typically 4-6 bytes)
- Wide character handling critical for CJK text
- Operations should be deterministic for testing
- Style delta avoids redundant SGR sequences
