# Feature Plan: Section 5.2 - Runtime Orchestration

## Problem Statement

TermUI needs a central runtime to orchestrate the entire application loop. The runtime must:
- Receive terminal events and route them to components
- Call component update functions and collect commands
- Trigger renders when state changes
- Coordinate shutdown cleanly

This is the "main loop" that ties together events, messages, updates, and rendering from The Elm Architecture.

## Solution Overview

Implement the Runtime GenServer with five core responsibilities:

1. **Runtime GenServer** - Main application process with state
2. **Event Dispatch** - Route events to components by type (keyboard→focused, mouse→position)
3. **Update Cycle** - Process messages through update functions, collect commands
4. **Render Trigger** - Mark dirty, call view, coordinate with framerate limiter
5. **Shutdown Coordination** - Clean exit with command completion and terminal restoration

### Key Design Decisions

- **Single GenServer runtime** - Centralized coordination simplifies state management
- **Event dispatch by type** - Keyboard to focused, mouse to spatial, global broadcasts
- **Dirty flag rendering** - Only render when state changes
- **Graceful shutdown** - Wait for commands, terminate components leaf-to-root

## Technical Details

### File Structure

```
lib/term_ui/
├── runtime.ex              # Main runtime GenServer
├── runtime/
│   ├── state.ex           # Runtime state struct
│   ├── dispatcher.ex      # Event dispatch logic
│   └── renderer.ex        # Render trigger logic
```

### Dependencies

- Section 5.1 (Event types, Message types, Elm behaviour)
- Phase 3 component system
- Phase 2 framerate limiter (for render coordination)

## Implementation Plan

### Task 5.2.1: Runtime GenServer ✅

- [x] 5.2.1.1 Implement `TermUI.Runtime` GenServer with application state
- [x] 5.2.1.2 Implement `init/1` building initial component tree from root module
- [x] 5.2.1.3 Implement `handle_info/2` for terminal events processing them through the loop
- [x] 5.2.1.4 Implement `handle_cast/2` for command results feeding back as messages

### Task 5.2.2: Event Dispatch ✅

- [x] 5.2.2.1 Implement keyboard event dispatch to focused component
- [x] 5.2.2.2 Implement mouse event dispatch using spatial index from Phase 3
- [x] 5.2.2.3 Implement broadcast dispatch for global events (resize, focus)
- [x] 5.2.2.4 Implement event transformation calling component's event_to_msg

### Task 5.2.3: Update Cycle ✅

- [x] 5.2.3.1 Implement message dispatch to component update function
- [x] 5.2.3.2 Implement state update in component process
- [x] 5.2.3.3 Implement command collection from update results
- [x] 5.2.3.4 Implement update propagation for parent-child message passing

### Task 5.2.4: Render Trigger ✅

- [x] 5.2.4.1 Implement dirty marking when component state changes
- [x] 5.2.4.2 Implement view call collecting render tree from component
- [x] 5.2.4.3 Implement render tree processing writing cells to buffer
- [x] 5.2.4.4 Integrate with framerate limiter for controlled rendering

### Task 5.2.5: Shutdown Coordination ✅

- [x] 5.2.5.1 Implement shutdown trigger from quit message or signal
- [x] 5.2.5.2 Implement graceful command completion waiting for pending commands
- [x] 5.2.5.3 Implement component tree shutdown in leaf-to-root order
- [x] 5.2.5.4 Implement terminal restoration ensuring clean exit

### Unit Tests ✅

- [x] Test runtime initializes with component tree
- [x] Test event dispatch routes to correct component
- [x] Test update cycle produces new state
- [x] Test commands collected from update results
- [x] Test render trigger marks buffer dirty
- [x] Test view produces correct render tree
- [x] Test shutdown terminates cleanly

## Success Criteria

1. Runtime GenServer starts and maintains application state
2. Events dispatch to correct components by type
3. Update cycle processes messages and collects commands
4. Render triggers on state changes with framerate limiting
5. Shutdown completes gracefully
6. All unit tests pass

## Current Status

- **Planning**: Complete
- **Implementation**: Complete
- **Tests**: 31 tests passing
