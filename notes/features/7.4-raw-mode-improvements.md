# Feature Plan: Section 7.4 - Raw Mode Improvements

## Problem Statement

Raw mode is essential for TUI applications—it disables line buffering and echo so applications receive each keystroke immediately. Currently:
- Terminal uses OTP 28's `shell.start_interactive({:noshell, :raw})` for raw mode
- This may not fully suppress echo on all systems
- No fallback exists for systems where OTP 28 raw mode doesn't work correctly

**Impact:** Without proper raw mode:
- Keys may be echoed to the screen, corrupting the display
- Input may be line-buffered, requiring Enter to send input
- Arrow keys might show ^[[A escape sequence text
- Applications can't respond immediately to individual keystrokes

## Solution Overview

Improve raw mode implementation with verification and fallbacks:

```
OTP 28 raw mode → verify behavior → stty fallback if needed
```

### Key Design Decisions

1. **Verify OTP 28 raw mode** - Test that echo and canonical mode are properly disabled
2. **Implement stty fallback** - Use system stty command when shell.start_interactive is insufficient
3. **Save/restore settings** - Preserve original terminal settings for clean restoration
4. **Platform detection** - Choose appropriate method based on OTP version and platform

### Architecture

```
┌────────────────┐     ┌─────────────┐     ┌─────────────┐
│ enable_raw_    │ --> │ Try OTP 28  │ --> │ Verify echo │
│ mode/0         │     │ shell.start │     │ disabled    │
└────────────────┘     └─────────────┘     └─────────────┘
                              │                   │
                              │ if not working    │
                              ▼                   │
                       ┌─────────────┐            │
                       │ stty        │ <──────────┘
                       │ fallback    │
                       └─────────────┘
```

## Technical Details

### File Structure

```
lib/term_ui/
└── terminal.ex              # Improve raw mode implementation
```

### Dependencies

- OTP 28+ `shell.start_interactive/1` - Primary raw mode method
- System `stty` command - Fallback method
- No new modules needed

### Existing Infrastructure

Current raw mode implementation in `terminal.ex` (lines 390-416):
- Uses `shell.start_interactive({:noshell, :raw})`
- Returns `{:ok, :raw_mode}` or `{:error, reason}`
- No verification or fallback

## Implementation Plan

### Task 7.4.1: OTP 28 Raw Mode Verification ✅

- [x] 7.4.1.1 Add verification function to test echo is disabled
- [x] 7.4.1.2 Add verification function to test canonical mode is disabled
- [x] 7.4.1.3 Test shell.start_interactive return values and behavior
- [x] 7.4.1.4 Document terminal-specific quirks discovered
- [x] 7.4.1.5 Add explicit stty configuration if needed for full raw mode

### Task 7.4.2: Fallback Implementation ✅

- [x] 7.4.2.1 Implement raw mode via stty system command as fallback
- [x] 7.4.2.2 Save original terminal settings before modification using `stty -g`
- [x] 7.4.2.3 Apply raw mode settings: -echo -icanon min 1 time 0
- [x] 7.4.2.4 Restore original settings on exit using saved settings
- [x] 7.4.2.5 Detect which method to use based on OTP version and platform

### Task 7.4.3: Echo Suppression ✅

- [x] 7.4.3.1 Verify -echo is applied in all raw mode paths
- [x] 7.4.3.2 Test that arrow keys don't show ^[[A etc
- [x] 7.4.3.3 Test that typed characters don't appear twice
- [x] 7.4.3.4 Add explicit echo disable if shell.start_interactive misses it
- [x] 7.4.3.5 Document terminal compatibility findings

### Unit Tests ✅

- [x] Test raw mode enables without error
- [x] Test input is received without echo
- [x] Test raw mode disables cleanly
- [x] Test fallback mode works on supported systems
- [x] Test original settings restored after exit
- [x] Test raw mode survives terminal type detection

## Success Criteria

1. Raw mode works correctly with OTP 28 shell.start_interactive
2. Fallback via stty works when OTP 28 method fails
3. Echo is fully suppressed (no ^[[A for arrows, no double characters)
4. Original terminal settings are saved and restored properly
5. Implementation handles errors gracefully
6. All existing tests continue to pass
7. New unit tests pass

## Current Status

- **Planning**: Complete
- **Implementation**: Complete
- **Tests**: Complete (13 tests passing)

## Notes/Considerations

- The current implementation at lines 390-416 in terminal.ex is the starting point
- `shell.start_interactive({:noshell, :raw})` may need additional stty settings
- Original settings can be captured with `stty -g` and restored with `stty <settings>`
- Raw mode settings: `-echo -icanon min 1 time 0`
- Must handle case where stty is not available (Windows, etc.)
- Consider using os_mon or similar to detect platform capabilities
