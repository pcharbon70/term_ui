# Feature: Task 2.8.1 - Implement Mouse Tracking Enable

**Branch:** `feature/2.8.1-mouse-tracking-enable`
**Base:** `multi-renderer`
**Date:** 2025-12-05
**Status:** In Progress

## Overview

Implement `enable_mouse/2` function for the Raw backend to enable mouse tracking with configurable modes. This allows changing mouse tracking mode after initialization.

## Requirements

From phase plan:
- 2.8.1.1 Implement `enable_mouse/2` accepting state and mode (`:click`, `:drag`, `:all`)
- 2.8.1.2 Enable X10 mouse tracking with `\e[?9h` for basic click
- 2.8.1.3 Enable button event tracking with `\e[?1002h` for drag
- 2.8.1.4 Enable any event tracking with `\e[?1003h` for all movement
- 2.8.1.5 Enable SGR extended mode with `\e[?1006h` for better coordinate handling
- 2.8.1.6 Update `mouse_mode` in state

## Technical Analysis

### Existing Infrastructure

The ANSI module already has mouse tracking functions:
- `ANSI.enable_mouse_tracking(:normal)` → `\e[?1000h` (click tracking)
- `ANSI.enable_mouse_tracking(:button)` → `\e[?1002h` (drag tracking)
- `ANSI.enable_mouse_tracking(:all)` → `\e[?1003h` (all movement)
- `ANSI.enable_sgr_mouse()` → `\e[?1006h` (SGR extended coordinates)

The Raw backend has:
- `mouse_mode_to_ansi/1` helper mapping backend modes to ANSI modes
- Mouse tracking setup in `init/1` for initial configuration
- `mouse_mode` field in state struct

### Mode Mapping Clarification

The phase plan mentions X10 (`\e[?9h`) for click mode, but X10 is deprecated and has limited coordinate range. The standard mapping should be:

| Backend Mode | ANSI Mode | Escape Sequence | Description |
|--------------|-----------|-----------------|-------------|
| `:click`     | `:normal` | `\e[?1000h`     | Button press/release |
| `:drag`      | `:button` | `\e[?1002h`     | Press/release + motion while pressed |
| `:all`       | `:all`    | `\e[?1003h`     | All mouse motion events |

This matches the existing `mouse_mode_to_ansi/1` function.

## Implementation Plan

### 1. Implement `enable_mouse/2`

```elixir
@doc """
Enables mouse tracking with the specified mode.

## Parameters

- `state` - Current backend state
- `mode` - Mouse tracking mode (`:click`, `:drag`, `:all`)

## Returns

- `{:ok, updated_state}` on success
"""
@spec enable_mouse(t(), mouse_mode()) :: {:ok, t()}
def enable_mouse(state, mode) when mode in [:click, :drag, :all] do
  # If already in this mode, no-op
  if state.mouse_mode == mode do
    {:ok, state}
  else
    # Disable current mode if active
    if state.mouse_mode != :none do
      disable_current_mouse_mode(state)
    end

    # Enable new mode
    ansi_mode = mouse_mode_to_ansi(mode)
    write_to_terminal(ANSI.enable_mouse_tracking(ansi_mode))
    write_to_terminal(ANSI.enable_sgr_mouse())

    {:ok, %{state | mouse_mode: mode}}
  end
end
```

### 2. Add Tests

Tests to add:
- `enable_mouse/2` with `:click` updates state
- `enable_mouse/2` with `:drag` updates state
- `enable_mouse/2` with `:all` updates state
- `enable_mouse/2` is idempotent (same mode → no change)
- `enable_mouse/2` has documentation

## Files to Modify

| File | Changes |
|------|---------|
| `lib/term_ui/backend/raw.ex` | Add `enable_mouse/2` function |
| `test/term_ui/backend/raw_test.exs` | Add tests for `enable_mouse/2` |
| `notes/planning/multi-renderer/phase-02-raw-backend.md` | Mark task complete |

## Verification

1. `mix compile` - no warnings
2. `mix test test/term_ui/backend/raw_test.exs` - all tests pass
3. `mix format --check-formatted` - properly formatted
