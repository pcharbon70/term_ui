# Feature: Task 2.5.1 - Implement draw_cells/2 Callback

**Branch:** `feature/2.5.1-draw-cells`
**Base:** `multi-renderer`
**Date:** 2025-12-05

## Overview

Implement the main cell drawing callback `draw_cells/2` for the Raw backend with batch optimization. This is the primary rendering interface that takes a list of positioned cells and outputs optimized ANSI sequences.

## Reference

See `notes/planning/multi-renderer/phase-02-raw-backend.md` Section 2.5.1.

## Subtasks from Plan

- [ ] 2.5.1.1 Implement `@impl true` `draw_cells/2` accepting state and list of `{position, cell}` tuples
- [ ] 2.5.1.2 Sort cells by row then column for sequential output
- [ ] 2.5.1.3 Group consecutive cells on same row for efficient cursor handling
- [ ] 2.5.1.4 Track current position and style to minimize escape sequences
- [ ] 2.5.1.5 Build output as iolist for efficient concatenation

## Design

### Cell Format

The Backend behaviour defines cells as:
```elixir
@type cell :: {char :: String.t(), fg :: color(), bg :: color(), attrs :: [atom()]}
```

The function signature:
```elixir
@spec draw_cells(t(), [{position(), cell()}]) :: {:ok, t()}
```

### Algorithm

1. **Sort cells** by row, then by column (row-major order)
2. **Process cells** sequentially:
   - Track current cursor position
   - Track current style state (fg, bg, attrs)
   - For each cell:
     - Move cursor if needed (skip if sequential on same row)
     - Apply style delta (only emit changed attributes)
     - Output character
3. **Batch output** into single iolist, perform single `IO.write/1`
4. **Update state** with final cursor position and style

### Style Delta Optimization

Instead of resetting and re-applying full style for every cell:
- Track `{fg, bg, attrs}` as current style
- Only emit escape sequences for changed attributes
- Reset with `\e[0m` only when transitioning to simpler style

### Cursor Optimization

- If next cell is at `{row, col+1}`, no cursor move needed (auto-advance)
- Otherwise use `move_cursor/2` logic (already implements optimization)

## Implementation

### Private Helper Functions

```elixir
# Generate iolist for a single cell with style and cursor handling
defp generate_cell_output(cell, current_style, current_pos, target_pos)

# Generate style delta sequence
defp style_sequence(new_style, current_style)

# Generate color sequence
defp color_sequence(:fg | :bg, color)

# Generate attribute sequences
defp attr_sequences(attrs)
```

## Files to Modify

- `lib/term_ui/backend/raw.ex` - Implement draw_cells/2 and helpers
- `test/term_ui/backend/raw_test.exs` - Add tests

## Tests to Add

- [ ] Test `draw_cells/2` with empty list returns unchanged state
- [ ] Test `draw_cells/2` with single cell
- [ ] Test `draw_cells/2` with multiple cells on same row
- [ ] Test `draw_cells/2` with cells on different rows
- [ ] Test cells are sorted by position before rendering
- [ ] Test cursor position updated after drawing
- [ ] Test style tracking updated after drawing
- [ ] Test state preserved except cursor_position and current_style

## Verification

1. `mix compile` - no warnings
2. `mix test test/term_ui/backend/raw_test.exs` - all tests pass
3. `mix format --check-formatted` - code formatted
