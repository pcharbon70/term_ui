# Feature Plan: 2.1 Cell and Buffer Data Structures

## Problem Statement

The rendering engine needs fundamental data structures to represent screen content. We need:
- A Cell structure to hold character, colors, and attributes for each screen position
- Display width handling for Unicode characters (CJK double-width, combining characters)
- A Style structure for building and merging visual styles
- A Buffer structure using ETS for efficient storage and access

These structures form the foundation for the entire rendering engine in Phase 2.

## Solution Overview

Implement four core modules:
1. `TermUI.Renderer.Cell` - Individual cell representation
2. `TermUI.Renderer.DisplayWidth` - Unicode character width calculation
3. `TermUI.Renderer.Style` - Fluent style builder with merging
4. `TermUI.Renderer.Buffer` - ETS-based screen buffer

### Key Design Decisions

- **Immutable cells** - Updates create new cells for efficient diffing
- **ETS ordered_set** - O(log n) access, efficient range operations
- **Compact color encoding** - Support :default, named, 256-color, and RGB
- **MapSet for attributes** - Fast membership checks and comparisons

## Technical Details

### File Structure
```
lib/term_ui/renderer/
├── cell.ex           # Cell struct and operations
├── display_width.ex  # Unicode width calculation
├── style.ex          # Style builder and merging
└── buffer.ex         # ETS-based buffer

test/term_ui/renderer/
├── cell_test.exs
├── display_width_test.exs
├── style_test.exs
└── buffer_test.exs
```

### Dependencies
- Phase 1 complete (terminal foundation)
- No external dependencies for width calculation (pure Elixir implementation)

## Implementation Plan

### Task 2.1.1: Cell Structure ✅
- [x] 2.1.1.1 Define `%Cell{char, fg, bg, attrs}` struct
- [x] 2.1.1.2 Implement color type (:default, named, 256-color, RGB)
- [x] 2.1.1.3 Implement attribute set (:bold, :dim, :italic, :underline, :blink, :reverse, :hidden, :strikethrough)
- [x] 2.1.1.4 Implement cell comparison for diffing
- [x] 2.1.1.5 Implement `Cell.empty/0` for default empty cell

### Task 2.1.2: Display Width Handling ✅
- [x] 2.1.2.1 Implement `display_width/1` for grapheme clusters
- [x] 2.1.2.2 Implement double-width character handling
- [x] 2.1.2.3 Implement combining character handling
- [x] 2.1.2.4 Implement text width calculation for strings

### Task 2.1.3: Style Structure ✅
- [x] 2.1.3.1 Define `%Style{fg, bg, attrs}` struct
- [x] 2.1.3.2 Implement fluent style builder functions
- [x] 2.1.3.3 Implement `Style.merge/2` for cascading
- [x] 2.1.3.4 Implement style to cell conversion

### Task 2.1.4: Buffer Structure ✅
- [x] 2.1.4.1 Implement `Buffer.new(rows, cols)` with ETS
- [x] 2.1.4.2 Implement `Buffer.get_cell/3` with bounds checking
- [x] 2.1.4.3 Implement `Buffer.set_cell/4`
- [x] 2.1.4.4 Implement `Buffer.clear_region/5`
- [x] 2.1.4.5 Implement `Buffer.resize/3` with content preservation

### Unit Tests ✅
- [x] Test cell creation with various colors/attributes
- [x] Test cell comparison detects all differences
- [x] Test display width for ASCII, CJK, combining characters
- [x] Test style builder produces correct structs
- [x] Test style merging overrides correctly
- [x] Test buffer initialization with empty cells
- [x] Test buffer get/set operations
- [x] Test buffer clear_region
- [x] Test buffer resize preserves content

## Success Criteria

1. All cell operations work correctly with various color/attribute combinations
2. Display width correctly identifies single, double, and zero-width characters
3. Style builder provides fluent API with proper merging
4. Buffer provides O(log n) access via ETS ordered_set
5. All unit tests pass
6. Credo strict mode passes

## Current Status

**Status**: ✅ Complete

### What Works
- All 4 modules implemented (Cell, DisplayWidth, Style, Buffer)
- 131 unit tests passing
- Full color support (default, named, 256-color, RGB)
- Unicode display width calculation (CJK double-width, combining chars)
- ETS-based buffer with concurrent access support
- Fluent style builder API

### What's Next
- Section 2.2: ETS-Based Double Buffering

### How to Run
```bash
mix test test/term_ui/renderer/
mix credo --strict
```

## Notes

- Cell comparison is critical for diff performance - optimize for common case (cells equal)
- Display width uses Unicode East Asian Width property - consider caching for performance
- Buffer uses ETS :ordered_set for row-major iteration during rendering
- Style merging follows CSS-like cascade - later values override earlier
