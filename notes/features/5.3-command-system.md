# Feature Plan: Section 5.3 - Command System

## Problem Statement

TermUI components need to perform side effects (timers, file I/O, clipboard operations) without blocking the UI or making update functions impure. The command system provides a declarative way to describe effects that the runtime executes asynchronously, sending results back as messages.

This completes the Elm Architecture triad: events trigger messages, messages update state and return commands, commands execute and produce result messages.

## Solution Overview

Implement a command system with five core components:

1. **Command Structure** - Data describing effects to perform
2. **Command Executor** - Task.Supervisor executing commands asynchronously
3. **Built-in Commands** - Timer, interval, file read, clipboard operations
4. **Command Cancellation** - Cancel running commands by ID
5. **Command Batching** - Concurrent execution with limits

### Key Design Decisions

- **Commands as data** - Structs describing effects, not functions (inspectable, testable)
- **Task.Supervisor isolation** - Failed commands don't crash the runtime
- **Result messages** - Commands specify the message to send on completion
- **Concurrent execution** - Independent commands run in parallel

## Technical Details

### File Structure

```
lib/term_ui/
├── command.ex              # Command struct and builders
├── command/
│   ├── executor.ex         # Task.Supervisor-based executor
│   └── registry.ex         # Command ID tracking for cancellation
```

### Dependencies

- Section 5.2 (Runtime for result delivery)
- Task.Supervisor for fault-isolated execution

## Implementation Plan

### Task 5.3.1: Command Structure

- [x] 5.3.1.1 Define `%Command{type: atom, payload: any, on_result: msg_type}` struct
- [x] 5.3.1.2 Define command types: `:timer`, `:interval`, `:file_read`, `:send_after`
- [x] 5.3.1.3 Implement command builder functions: `Command.timer(ms, on_result)`
- [x] 5.3.1.4 Implement command validation ensuring valid type and payload

### Task 5.3.2: Command Executor

- [x] 5.3.2.1 Implement Task.Supervisor for command execution
- [x] 5.3.2.2 Implement `execute/3` starting async task for command
- [x] 5.3.2.3 Implement result delivery sending message to runtime
- [x] 5.3.2.4 Implement error handling converting failures to error messages

### Task 5.3.3: Built-in Commands

- [x] 5.3.3.1 Implement timer command scheduling message after delay
- [x] 5.3.3.2 Implement interval command scheduling repeated messages
- [x] 5.3.3.3 Implement file_read command reading file and sending content
- [x] 5.3.3.4 Implement send_after command for delayed message delivery

### Task 5.3.4: Command Cancellation

- [x] 5.3.4.1 Implement command ID tracking for cancel reference
- [x] 5.3.4.2 Implement `cancel/1` terminating running command task
- [x] 5.3.4.3 Implement automatic cancellation on component unmount
- [x] 5.3.4.4 Implement timeout cancellation for commands exceeding duration

### Task 5.3.5: Command Batching

- [x] 5.3.5.1 Implement concurrent execution for independent commands
- [x] 5.3.5.2 Implement command chaining for sequential execution
- [x] 5.3.5.3 Implement batch result tracking
- [x] 5.3.5.4 Implement max concurrent limit preventing resource exhaustion

### Unit Tests

- [x] Test command structure contains required fields
- [x] Test command execution runs async task
- [x] Test result delivery sends message to runtime
- [x] Test error handling converts failure to error message
- [x] Test timer command delivers message after delay
- [x] Test interval command delivers repeated messages
- [x] Test file_read command returns file content
- [x] Test command cancellation prevents result delivery
- [x] Test batch execution runs commands concurrently
- [x] Test max concurrent limits active tasks

## Success Criteria

1. Commands are declarative data structures
2. Executor runs commands under Task.Supervisor
3. Results deliver as messages to components
4. Errors convert to error messages
5. Cancellation stops running commands
6. Concurrent execution with limits
7. All unit tests pass

## Current Status

- **Planning**: Complete
- **Implementation**: Complete
- **Tests**: 36 tests passing
