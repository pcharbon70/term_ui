# Feature: Task 2.7.1 - Implement poll_event/2 Callback

**Branch:** `feature/2.7.1-poll-event`
**Base:** `multi-renderer`
**Date:** 2025-12-05
**Status:** Complete

## Overview

Implement the `poll_event/2` callback for the Raw backend. This enables reading keyboard and mouse input with timeout support.

## Implementation

### Approach

Used a synchronous polling approach that:
1. Checks event queue first (for previously parsed events)
2. Checks input buffer for parseable sequences
3. Uses `Task.async` + `Task.yield` for non-blocking reads with timeout
4. Delegates escape sequence parsing to existing `EscapeParser` module
5. Handles partial sequences with 50ms timeout for disambiguation

### State Changes

Added two new fields to the Raw backend state:
- `input_buffer` - Buffer for partial escape sequences
- `event_queue` - Queue for parsed events when multiple events are parsed at once

### Key Functions

- `poll_event/2` - Main callback entry point
- `try_parse_buffer/1` - Parses buffered input or returns queued events
- `read_input_with_timeout/2` - Reads from stdin with Task-based timeout
- `wait_for_escape_completion/2` - Handles escape sequence timeout disambiguation
- `emit_partial_escape/2` - Emits events when partial sequences timeout

## Tasks Completed

- [x] 2.7.1.1 Implement `@impl true` `poll_event/2` accepting state and timeout
- [x] 2.7.1.2 Use non-blocking read with timeout (Task with yield/shutdown)
- [x] 2.7.1.3 Return `{:ok, event, state}` when input available
- [x] 2.7.1.4 Return `{:timeout, state}` when timeout expires
- [x] 2.7.1.5 Handle read errors gracefully

## Tests Added

14 new tests in `describe "poll_event/2 callback"`:
- Returns timeout when no input
- State has input_buffer initialized
- Parses buffered input
- Parses multiple buffered characters one at a time
- Parses enter, tab, backspace keys
- Parses ctrl+c
- Parses arrow keys (up, down, left, right)
- Parses function keys (F1-F4)
- Has documentation

1 test in `describe "poll_event/2 escape sequence timeout"`:
- Lone ESC emits escape key event

## Files Modified

| File | Changes |
|------|---------|
| `lib/term_ui/backend/raw.ex` | Added poll_event/2 implementation (+200 lines) |
| `test/term_ui/backend/raw_test.exs` | Added 15 tests (+160 lines) |
| `notes/planning/multi-renderer/phase-02-raw-backend.md` | Marked Task 2.7.1 complete |

## Verification

1. `mix compile` - no warnings ✓
2. `mix test test/term_ui/backend/raw_test.exs` - 143 tests pass ✓
3. `mix format --check-formatted` - code formatted ✓
