# Feature 1.6: Integration Tests

## Problem Statement

Unit tests validate individual components in isolation, but integration tests verify that all terminal foundation components work together correctly. Without integration tests, we could miss interaction bugs between raw mode, escape sequences, capability detection, and platform abstraction layers.

### Impact
- Validates complete terminal workflows
- Catches interaction bugs that unit tests miss
- Verifies real-world terminal behavior
- Ensures robust crash recovery and cleanup
- Confirms cross-platform consistency

## Solution Overview

Implement comprehensive integration tests that exercise complete terminal workflows on actual terminals (not mocks) when possible. Use PTY allocation for CI environments to test input/output round-trips.

### Key Design Decisions
1. **Real terminals over mocks** - Integration tests should use actual terminal I/O
2. **PTY-based testing** - Use pseudo-terminals for automated round-trip tests
3. **Lifecycle validation** - Test init → operation → cleanup sequences
4. **Cross-platform matrix** - CI tests on Linux, macOS, and Windows
5. **Graceful degradation** - Skip tests that require unavailable features

### Scope Note
Some integration tests require actual terminal features (raw mode, PTY) that may not be available in all environments. Tests should be marked appropriately and skip gracefully when requirements aren't met.

## Technical Details

### Test Structure
```
test/integration/
├── terminal_lifecycle_test.exs    # 1.6.1 - Init/shutdown/recovery
├── round_trip_test.exs            # 1.6.2 - I/O verification
├── capability_accuracy_test.exs   # 1.6.3 - Detection validation
└── cross_platform_test.exs        # 1.6.4 - Platform consistency
```

### Test Infrastructure

#### PTY Module for Round-Trip Testing
We need a helper module to create PTY pairs for testing. This allows us to:
- Write input bytes to the slave side
- Read output from the master side
- Verify escape sequences are generated correctly
- Test event parsing with real byte streams

#### Test Helpers
- `with_terminal/1` - Sets up and tears down terminal for test
- `capture_terminal_output/1` - Captures raw terminal output
- `send_terminal_input/2` - Sends input to terminal under test
- `assert_terminal_restored/0` - Verifies terminal is in clean state

### Testing Approaches

#### Terminal Lifecycle Testing (1.6.1)
Tests verify the complete sequence:
1. Detect capabilities
2. Enable raw mode
3. Enter alternate screen
4. Hide cursor
5. [perform operations]
6. Show cursor
7. Leave alternate screen
8. Disable raw mode
9. Restore settings

Also tests crash recovery using `Process.exit` and `trap_exit`.

#### Round-Trip Testing (1.6.2)
Uses PTY pairs to verify:
- Cursor position queries return correct coordinates
- Key sequences parse to expected events
- Mouse sequences parse to correct button/coordinates
- Styles render correctly

#### Capability Detection Accuracy (1.6.3)
Tests against known terminal capabilities:
- xterm: 256 colors, mouse, Unicode
- xterm-256color: 256 colors
- screen/tmux: varying capabilities
- Windows Terminal: true color, VT sequences

#### Cross-Platform Integration (1.6.4)
Verifies consistent behavior across:
- Linux (Ubuntu)
- macOS
- Windows 10+

Same test code should produce equivalent results.

## Success Criteria

1. ✅ Terminal lifecycle tests verify complete init/shutdown sequences
2. ✅ Crash recovery tests ensure terminal restoration
3. ✅ Round-trip tests validate cursor, key, mouse, and style handling
4. ✅ Capability tests match known terminal features
5. ✅ Cross-platform tests pass on Linux/macOS/Windows
6. ✅ Tests skip gracefully when features unavailable
7. ✅ All tests run in CI matrix

## Implementation Plan

### Phase 1: Test Infrastructure
- [ ] Create test/integration directory structure
- [ ] Implement test helper module with setup/teardown
- [ ] Create PTY wrapper for round-trip testing (Unix only)
- [ ] Implement terminal state verification helpers

### Phase 2: Terminal Lifecycle Testing (1.6.1)
- [ ] 1.6.1.1 Test complete initialization sequence
- [ ] 1.6.1.2 Test clean shutdown sequence
- [ ] 1.6.1.3 Test crash recovery
- [ ] 1.6.1.4 Test reinitialization

### Phase 3: Input/Output Round-Trip Testing (1.6.2)
- [ ] 1.6.2.1 Test cursor positioning round-trip
- [ ] 1.6.2.2 Test key event round-trip
- [ ] 1.6.2.3 Test mouse event round-trip
- [ ] 1.6.2.4 Test style round-trip

### Phase 4: Capability Detection Accuracy (1.6.3)
- [ ] 1.6.3.1 Test color capability detection
- [ ] 1.6.3.2 Test mouse support detection
- [ ] 1.6.3.3 Test Unicode detection
- [ ] 1.6.3.4 Test capability query timeouts

### Phase 5: Cross-Platform Integration (1.6.4)
- [ ] 1.6.4.1 Test initialization on all platforms
- [ ] 1.6.4.2 Test input parsing consistency
- [ ] 1.6.4.3 Test terminal size detection
- [ ] 1.6.4.4 Test cleanup on all platforms

## Platform-Specific Considerations

### Linux
- Full PTY support via :pty module or external library
- SIGWINCH for resize events
- /dev/pts filesystem for PTY allocation

### macOS
- Similar to Linux for PTY handling
- Uses /dev/pty* device files
- May have slight timing differences

### Windows
- No native PTY until Windows 10 1809 (ConPTY)
- Tests may need to use Windows-specific APIs
- Some tests may be skipped on Windows

### CI Environment
- GitHub Actions supports Linux and macOS directly
- Windows runners available but may have terminal limitations
- Use matrix strategy for comprehensive coverage

## Notes/Considerations

### PTY Testing Strategy
We have two options for PTY-based testing:
1. **Pure Elixir** - Use `:erlang.open_port` with PTY options
2. **External library** - Use ex_pty or similar

Starting with pure Elixir approach, can add library later if needed.

### Test Timeouts
Integration tests may be slower than unit tests. Set appropriate timeouts:
- Lifecycle tests: 5 seconds
- Round-trip tests: 2 seconds per test
- Capability queries: 1 second timeout

### Flaky Test Prevention
Terminal tests can be flaky due to timing. Mitigation:
- Use explicit synchronization points
- Add small delays where necessary
- Retry on specific failures
- Clear terminal state between tests

## Current Status

**Status**: In Progress - Test Infrastructure

### What Works
- Section 1.1-1.5 complete with unit tests
- 224 total tests passing

### What's Next
- Create test helper infrastructure
- Implement lifecycle tests
- Add round-trip tests with PTY

### How to Run
```bash
cd /home/ducky/code/term_ui
mix test test/integration/
```
