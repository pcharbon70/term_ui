# Feature Plan: Section 5.7 - Focus Events

## Problem Statement

TermUI needs to detect when the terminal window gains or loses system focus. This enables optimization (pausing animations when backgrounded) and proper state management (autosaving when losing focus). Not all terminals support focus events, so applications must work without them.

## Solution Overview

Implement a focus event system with four components:

1. **Focus Event Detection** - Parse focus sequences from terminal input
2. **Focus State Management** - Track focus state in runtime
3. **Focus-Based Optimization** - Reduce work when backgrounded
4. **Focus Actions** - Execute tasks on focus changes

### Key Design Decisions

- **Optional feature** - Applications work without focus event support
- **GenServer-based tracker** - Maintains focus state with configurable actions
- **Optimization hooks** - Components can query focus state
- **Action registration** - Custom focus gained/lost handlers

## Technical Details

### File Structure

```
lib/term_ui/
├── focus.ex                  # Focus utilities and escape sequences
├── focus/
│   └── tracker.ex            # Focus state tracker GenServer
```

### Dependencies

- Section 5.1 Event types (Event.Focus)
- Section 1.1 Terminal capabilities for focus mode

## Implementation Plan

### Task 5.7.1: Focus Event Detection

- [x] 5.7.1.1 Implement focus event parsing recognizing ESC[I and ESC[O
- [x] 5.7.1.2 Implement focus event type with gained/lost variants
- [x] 5.7.1.3 Implement focus mode activation during terminal setup
- [x] 5.7.1.4 Implement capability detection for focus event support

### Task 5.7.2: Focus State Management

- [x] 5.7.2.1 Implement focus state tracking in runtime
- [x] 5.7.2.2 Implement `has_focus?/0` query for current focus state
- [x] 5.7.2.3 Implement focus change broadcast to all components
- [x] 5.7.2.4 Implement focus state in view for conditional rendering

### Task 5.7.3: Focus-Based Optimization

- [x] 5.7.3.1 Implement animation pause when focus lost
- [x] 5.7.3.2 Implement framerate reduction when backgrounded
- [x] 5.7.3.3 Implement render skip when unfocused
- [x] 5.7.3.4 Implement resume on focus gained

### Task 5.7.4: Focus Actions

- [x] 5.7.4.1 Implement focus action registration for focus gained/lost
- [x] 5.7.4.2 Implement autosave action saving state on focus lost
- [x] 5.7.4.3 Implement refresh action updating content on focus gained
- [x] 5.7.4.4 Implement cursor hide on focus lost (optional)

### Unit Tests

- [x] Test focus event parsing recognizes focus sequences
- [x] Test focus state updates on focus events
- [x] Test has_focus? returns current state
- [x] Test focus broadcast notifies all components
- [x] Test animation pause on focus lost
- [x] Test render resume on focus gained
- [x] Test focus actions execute on focus change

## Success Criteria

1. Focus mode activation sends correct escape sequences
2. Focus state tracks correctly across gained/lost events
3. Optimization hooks work correctly
4. Focus actions execute on state changes
5. All unit tests pass

## Current Status

- **Planning**: Complete
- **Implementation**: Complete
- **Tests**: 28 tests passing

