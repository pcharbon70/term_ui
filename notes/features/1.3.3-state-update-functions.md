# Feature 1.3.3: Implement State Update Functions

## Overview

Add immutable update functions to `TermUI.Backend.State` for convenient state manipulation. These functions follow Elixir conventions for updating immutable data structures.

## Reference

- Phase plan: `notes/planning/multi-renderer/phase-01-backend-selector.md`
- Task: 1.3.3 Implement State Update Functions
- Depends on: Task 1.3.1 (State Structure), Task 1.3.2 (State Constructors) - completed

## Subtasks

- [x] 1.3.3.1 Implement `put_backend_state/2` for updating inner backend state
- [x] 1.3.3.2 Implement `put_size/2` for updating cached dimensions
- [x] 1.3.3.3 Implement `put_capabilities/2` for updating capabilities map
- [x] 1.3.3.4 Implement `mark_initialized/1` for setting initialized flag

## Implementation Notes

### Function Signatures

```elixir
@spec put_backend_state(t(), term()) :: t()
def put_backend_state(state, backend_state)

@spec put_size(t(), dimensions()) :: t()
def put_size(state, size)

@spec put_capabilities(t(), map()) :: t()
def put_capabilities(state, capabilities)

@spec mark_initialized(t()) :: t()
def mark_initialized(state)
```

### put_backend_state/2

Updates the inner backend-specific state.

```elixir
state = State.new_raw()
state = State.put_backend_state(state, %{cursor: {1, 1}})
```

### put_size/2

Updates the cached terminal dimensions.

```elixir
state = State.new_tty(%{})
state = State.put_size(state, {24, 80})
```

### put_capabilities/2

Updates the capabilities map (typically used after capability re-detection).

```elixir
state = State.new_tty(%{colors: :basic})
state = State.put_capabilities(state, %{colors: :true_color, unicode: true})
```

### mark_initialized/1

Sets the initialized flag to true.

```elixir
state = State.new_tty(%{})
state = State.mark_initialized(state)
assert state.initialized == true
```

## Testing Strategy

- Test `put_backend_state/2` returns new state with updated backend_state
- Test `put_backend_state/2` preserves other fields
- Test `put_size/2` returns new state with updated size
- Test `put_size/2` accepts nil to clear cached size
- Test `put_size/2` accepts {rows, cols} tuple
- Test `put_capabilities/2` returns new state with updated capabilities
- Test `put_capabilities/2` replaces entire map (not merge)
- Test `mark_initialized/1` sets initialized to true
- Test `mark_initialized/1` is idempotent
- Test all update functions return new struct (immutability)

## Files Modified

- `lib/term_ui/backend/state.ex` - Add update functions
- `test/term_ui/backend/state_test.exs` - Add update function tests
