# Feature: Task 2.2.3 - Implement shutdown/1 Callback

## Overview

Implement the `shutdown/1` callback for the Raw backend. This callback restores the terminal to its pre-init state, ensuring clean cleanup even if individual operations fail.

## Reference

- Planning document: `notes/planning/multi-renderer/phase-02-raw-backend.md`
- Branch: `feature/2.2.3-shutdown-callback`
- Parent branch: `multi-renderer`

## Tasks

### Task 2.2.3: Implement shutdown/1 Callback

- [x] 2.2.3.1 Implement `@impl true` `shutdown/1` accepting state
- [x] 2.2.3.2 Disable mouse tracking if it was enabled
- [x] 2.2.3.3 Show cursor with `\e[?25h`
- [x] 2.2.3.4 Leave alternate screen with `\e[?1049l` if it was entered
- [x] 2.2.3.5 Reset all attributes with `\e[0m`
- [x] 2.2.3.6 Return to cooked mode with `:shell.start_interactive({:noshell, :cooked})`
- [x] 2.2.3.7 Return `:ok`

### Task 2.2.4: Implement Error-Safe Shutdown

- [x] 2.2.4.1 Wrap each shutdown step in try/rescue
- [x] 2.2.4.2 Log errors but continue cleanup sequence
- [x] 2.2.4.3 Ensure cooked mode restoration happens last and is attempted even after errors
- [x] 2.2.4.4 Make shutdown idempotent (safe to call multiple times)

## Implementation Plan

### Phase 1: Shutdown Sequence

Order of cleanup operations (reverse of init):
1. Disable mouse tracking (if `mouse_mode != :none`)
2. Show cursor (always, regardless of state - defensive)
3. Reset all text attributes
4. Leave alternate screen (if `alternate_screen == true`)
5. Return to cooked mode

### Phase 2: Error Safety

Each step will be wrapped to ensure:
- Individual failures don't prevent subsequent steps
- Errors are logged via Logger.warning
- Always returns `:ok`
- Safe to call multiple times (idempotent)

### Phase 3: Defensive Cleanup

Following the Terminal module pattern:
- Disable ALL mouse tracking modes defensively (not just the one in state)
- Always show cursor (even if state says it's visible)
- This ensures cleanup even if state is inconsistent

## Files to Modify

- `lib/term_ui/backend/raw.ex` - Implement shutdown/1 callback
- `test/term_ui/backend/raw_test.exs` - Add unit tests for shutdown/1

## Testing Strategy

### Unit Tests to Add

1. Test `shutdown/1` returns `:ok`
2. Test `shutdown/1` is idempotent (can be called twice safely)
3. Test `shutdown/1` works with different state configurations

## Error Handling

- All I/O operations wrapped in `safe_write/1` helper
- `:shell.start_interactive/1` wrapped in try/rescue
- Logger.warning for any failures
- Always return `:ok`
