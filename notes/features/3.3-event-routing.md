# Feature Plan: 3.3 Event Routing

## Problem Statement

Components need to receive input events (keyboard, mouse, focus) from the terminal. Without proper event routing:
- Events don't reach the correct component
- Focus-based keyboard routing is impossible
- Mouse events can't target components by position
- Event bubbling/propagation patterns aren't supported

We need an event routing system that:
1. Routes keyboard events to focused component
2. Routes mouse events to component at position
3. Supports event propagation (bubble/capture)
4. Enables spatial indexing for efficient mouse routing

## Solution Overview

Implement an event routing system with these components:

1. `TermUI.Event` - Event type definitions
2. `TermUI.EventRouter` - Central router GenServer
3. `TermUI.SpatialIndex` - Position-based component lookup
4. Event propagation through component tree

### Key Design Decisions

- **GenServer router** - Central coordinator for all event routing
- **ETS spatial index** - Fast coordinate-to-component lookup
- **Bubble by default** - Events propagate up until handled
- **Coordinate transformation** - Screen coords to component-local
- **Integration with Registry** - Uses ComponentRegistry for lookups

### Event Flow

```
Terminal Input → EventRouter → Route by type → Target Component
                     ↓                              ↓
              Keyboard: Focus              Mouse: Spatial Index
                     ↓                              ↓
              Focused Component          Component at (x, y)
                     ↓                              ↓
              handle_event/2 ←──────────────────────┘
                     ↓
              Bubble if unhandled
```

## Technical Details

### File Structure

```
lib/term_ui/
├── event.ex                  # Event type definitions
├── event_router.ex           # Central event router
├── spatial_index.ex          # Position-based lookup
└── event/
    └── propagation.ex        # Propagation utilities

test/term_ui/
├── event_test.exs
├── event_router_test.exs
├── spatial_index_test.exs
└── event/
    └── propagation_test.exs
```

### Core Types

```elixir
# Event types
@type key_event :: %{type: :key, key: atom(), char: String.t() | nil, modifiers: [atom()]}
@type mouse_event :: %{type: :mouse, action: atom(), button: atom(), x: integer(), y: integer(), modifiers: [atom()]}
@type focus_event :: %{type: :focus, action: :gained | :lost}

# Routing result
@type route_result :: :handled | :unhandled | :stop

# Propagation phase
@type phase :: :capture | :target | :bubble
```

### Dependencies

- Section 3.1 (Component behaviours)
- Section 3.2 (Component lifecycle, Registry)
- Phase 1 event parsing (KeyEvent, MouseEvent from terminal)

## Implementation Plan

### Task 3.3.1: Event Types

Define event structs matching Phase 1 parser output.

- [x] 3.3.1.1 Create `TermUI.Event.Key` struct
- [x] 3.3.1.2 Create `TermUI.Event.Mouse` struct
- [x] 3.3.1.3 Create `TermUI.Event.Focus` struct
- [x] 3.3.1.4 Create `TermUI.Event.Custom` struct for app events
- [x] 3.3.1.5 Implement event helper functions

### Task 3.3.2: Spatial Index

Implement position-based component lookup for mouse events.

- [x] 3.3.2.1 Create `TermUI.SpatialIndex` module with ETS
- [x] 3.3.2.2 Implement `update/4` to register component bounds
- [x] 3.3.2.3 Implement `remove/1` to unregister component
- [x] 3.3.2.4 Implement `find_at/2` to get component at position
- [x] 3.3.2.5 Implement z-order handling for overlapping components

### Task 3.3.3: Event Router

Implement central event routing GenServer.

- [x] 3.3.3.1 Create `TermUI.EventRouter` GenServer
- [x] 3.3.3.2 Implement focus state tracking
- [x] 3.3.3.3 Implement keyboard event routing to focused
- [x] 3.3.3.4 Implement mouse event routing via spatial index
- [x] 3.3.3.5 Implement broadcast events (resize)

### Task 3.3.4: Event Propagation

Implement bubble/capture propagation through tree.

- [x] 3.3.4.1 Implement bubble phase (target → root)
- [x] 3.3.4.2 Implement capture phase (root → target)
- [x] 3.3.4.3 Implement propagation stopping on :handled
- [x] 3.3.4.4 Track component parent relationships

### Task 3.3.5: Event Transformation

Transform events for component-local handling.

- [x] 3.3.5.1 Implement coordinate transformation (screen → local)
- [x] 3.3.5.2 Implement event metadata addition
- [x] 3.3.5.3 Implement event filtering by component

### Unit Tests - Section 3.3

#### Event Type Tests
- [x] Test Key event creation with modifiers
- [x] Test Mouse event with coordinates
- [x] Test Focus event gain/lost
- [x] Test Custom event with payload

#### Spatial Index Tests
- [x] Test component registration with bounds
- [x] Test find_at returns correct component
- [x] Test overlapping components use z-order
- [x] Test remove clears component

#### Event Router Tests
- [x] Test keyboard routes to focused component
- [x] Test mouse routes to component at position
- [x] Test broadcast reaches all components
- [x] Test focus change updates routing

#### Propagation Tests
- [x] Test bubble propagates to parent
- [x] Test handled stops propagation
- [x] Test unhandled continues bubbling

## Success Criteria

1. **Event types** properly define all input events
2. **Spatial index** fast lookup by coordinates
3. **Router** correctly routes by event type
4. **Focus routing** sends keyboard to focused
5. **Mouse routing** uses spatial index
6. **Propagation** bubbles unhandled events
7. All unit tests pass
8. Documentation complete

## Current Status

**Status**: Complete

### Summary
- All tasks completed
- 111 new tests added
- Total project tests: 1107
- All tests passing

### How to Run
```bash
mix test test/term_ui/event_test.exs
mix test test/term_ui/event_router_test.exs
mix test test/term_ui/spatial_index_test.exs
mix test test/term_ui/event/propagation_test.exs
mix test test/term_ui/event/transformation_test.exs
```

## Notes

### Design Considerations

- **Focus vs Position** - Keyboard uses focus, mouse uses position
- **Z-order** - Higher z-index receives mouse events first
- **Coordinate systems** - Screen absolute vs component local
- **Parent tracking** - Need parent refs for bubbling

### Integration Points

- ComponentRegistry for component lookup
- ComponentServer for event delivery
- Focus management (Section 3.4) uses router focus state
