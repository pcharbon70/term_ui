# Feature: Section 6.11.2 StreamWidget

## Problem Statement

Applications need to display streaming data from various sources (GenStage pipelines, GenServer streams, message queues) while properly handling backpressure. Without proper backpressure management, widgets can become overwhelmed by high-velocity data streams, leading to memory exhaustion or UI unresponsiveness. A dedicated StreamWidget is needed that integrates with GenStage's demand-based flow control.

## Solution Overview

Implement a StreamWidget that:
- Acts as a GenStage consumer for backpressure-aware data streaming
- Manages demand-based data flow to prevent overwhelming the UI
- Provides buffer management with configurable overflow strategies
- Supports pause/resume controls for stream management
- Rate limits rendering to maintain UI responsiveness
- Displays real-time stream statistics (items/sec, buffer size)

## Requirements (from Phase 6 Planning)

### 6.11.2 StreamWidget

- [x] 6.11.2.1 Implement GenStage consumer for data source
- [x] 6.11.2.2 Implement backpressure handling (demand-based)
- [x] 6.11.2.3 Implement buffer management with overflow strategies
- [x] 6.11.2.4 Implement pause/resume stream control
- [x] 6.11.2.5 Implement rate limiting for rendering
- [x] 6.11.2.6 Implement stream statistics display (items/sec)

## Technical Design

### Stream Item Structure

```elixir
@type stream_item :: %{
  id: non_neg_integer(),        # Unique item ID
  timestamp: DateTime.t(),       # When item was received
  data: any(),                   # The actual data
  metadata: map()                # Optional metadata
}
```

### Buffer Overflow Strategies

```elixir
@type overflow_strategy ::
  :drop_oldest    # Remove oldest items when buffer full
  | :drop_newest  # Reject new items when buffer full
  | :block        # Block producer (via backpressure) when full
  | :sliding      # Keep N most recent items
```

### Stream State

```elixir
@type stream_state :: :idle | :running | :paused | :error

@type stats :: %{
  items_received: non_neg_integer(),
  items_dropped: non_neg_integer(),
  items_per_second: float(),
  buffer_size: non_neg_integer(),
  buffer_capacity: non_neg_integer(),
  last_update: DateTime.t()
}
```

### Keyboard Controls

| Key | Action |
|-----|--------|
| Space | Toggle pause/resume |
| c | Clear buffer |
| s | Toggle stats display |
| Up/Down | Scroll through buffer |
| Home/End | Jump to first/last item |

## Implementation Plan

### Step 1: Core Structure (6.11.2.1)
- [x] Create `lib/term_ui/widgets/stream_widget.ex`
- [x] Define types and stream item structure
- [x] Implement `new/1` for props creation
- [x] Implement `init/1` for state initialization
- [x] Implement companion GenStage consumer module

### Step 2: Backpressure Handling (6.11.2.2)
- [x] Implement demand calculation based on buffer capacity
- [x] Consumer forwards events to widget via messages
- [x] Implement demand adjustment based on processing rate
- [x] Track pending demand

### Step 3: Buffer Management (6.11.2.3)
- [x] Implement queue-based buffer with configurable size
- [x] Implement `:drop_oldest` strategy
- [x] Implement `:drop_newest` strategy
- [x] Implement `:block` strategy (signals consumer to stop)
- [x] Implement `:sliding` window strategy
- [x] Track dropped items count

### Step 4: Pause/Resume Control (6.11.2.4)
- [x] Implement pause state
- [x] Implement resume state
- [x] Toggle with Space key
- [x] Show pause indicator in status bar

### Step 5: Rate Limiting (6.11.2.5)
- [x] Implement render throttling via configurable interval
- [x] Batch items for rendering
- [x] Track last render time
- [x] Configurable render_rate_ms prop

### Step 6: Statistics Display (6.11.2.6)
- [x] Calculate items per second (rolling window)
- [x] Display buffer usage
- [x] Display dropped item count
- [x] Display stream state
- [x] Toggle stats visibility with 's' key

### Step 7: Public API
- [x] `add_item/2` - Add single item directly
- [x] `add_items/2` - Add multiple items directly
- [x] `pause/1` - Pause receiving items
- [x] `resume/1` - Resume receiving items
- [x] `clear/1` - Clear buffer
- [x] `get_stats/1` - Get current statistics
- [x] `set_buffer_size/2` - Change buffer capacity
- [x] `set_overflow_strategy/2` - Change overflow strategy
- [x] `buffer_count/1` - Get buffer item count
- [x] `paused?/1` - Check if paused
- [x] `stream_state/1` - Get stream state
- [x] `get_items/1` - Get buffer contents

### Step 8: Tests
- [x] Test widget initialization
- [x] Test add_item/add_items
- [x] Test buffer overflow strategies (drop_oldest, drop_newest, block, sliding)
- [x] Test pause/resume controls
- [x] Test clear buffer
- [x] Test navigation (up/down/page/home/end)
- [x] Test statistics calculation
- [x] Test keyboard controls
- [x] Test handle_info messages
- [x] Test rendering
- [x] Test custom item renderer

### Step 9: Example Application
- [x] Create `examples/stream_widget/` directory
- [x] Implement streaming data producer
- [x] Show pause/resume functionality
- [x] Demonstrate overflow strategies
- [x] Display statistics

## Success Criteria

- [x] StreamWidget receives items via messages
- [x] Companion consumer handles GenStage integration
- [x] Buffer overflow strategies work correctly
- [x] Pause/resume controls stream flow
- [x] Rate limiting maintains UI responsiveness
- [x] Statistics display updates in real-time
- [x] All tests pass (46 tests)
- [x] Example application demonstrates features

## Current Status

**Status**: COMPLETED

**What Works**:
- StreamWidget fully implemented
- All 6 requirements from Phase 6 planning met
- 46 comprehensive tests passing
- Example application demonstrating stream monitoring

**Files Created**:
- `lib/term_ui/widgets/stream_widget.ex` (~690 lines)
- `lib/term_ui/widgets/stream_widget/consumer.ex` (~100 lines)
- `test/term_ui/widgets/stream_widget_test.exs` (41 tests)
- `test/term_ui/widgets/stream_widget/consumer_test.exs` (5 tests)
- `examples/stream_widget/` (example application)
- `notes/features/6.11.2-streamwidget.md` (this document)
- `notes/summaries/6.11.2-streamwidget-summary.md`

**Test Coverage**:
- 46 tests covering all features
- Props and initialization
- Add items and buffer management
- Overflow strategies (4 strategies)
- Pause/resume
- Clear buffer
- Navigation
- Statistics
- Handle_info messages
- Rendering
- Custom item renderer
- Consumer integration
