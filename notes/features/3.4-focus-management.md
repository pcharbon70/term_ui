# Feature Plan: 3.4 Focus Management

## Problem Statement

Components need to know which widget receives keyboard input. Without focus management:
- All components would receive keyboard events (incorrect)
- Users can't navigate between interactive widgets
- Modal dialogs can't trap focus within their boundaries
- No visual feedback showing which widget is active

We need a focus management system that:
1. Tracks currently focused component
2. Provides Tab/Shift+Tab navigation between focusable components
3. Supports focus trapping for modals
4. Provides focus visual indicators
5. Integrates with event routing

## Solution Overview

Implement a focus management system with these components:

1. `TermUI.FocusManager` - Central focus state manager
2. Focus traversal with Tab order calculation
3. Focus properties for component focus behavior
4. Focus trapping for modal/dialog contexts
5. Focus indicator styling

### Key Design Decisions

- **Dedicated FocusManager** - Separate from EventRouter for clarity
- **Focus stack** - Stack-based focus history for modal contexts
- **Position-based tab order** - Default order by screen position
- **Focus groups** - Named groups for focus trapping
- **Integration with EventRouter** - FocusManager updates EventRouter focus state

### Focus Flow

```
Tab Key → FocusManager → Calculate Tab Order → Get Next Focusable
                ↓                                      ↓
         Update Focus State ←──────────────────────────┘
                ↓
         Send Focus Events (blur old, focus new)
                ↓
         Update EventRouter
```

## Technical Details

### File Structure

```
lib/term_ui/
├── focus_manager.ex         # Central focus management
└── focus/
    ├── traversal.ex         # Tab order calculation
    └── indicator.ex         # Focus indicator styles

test/term_ui/
├── focus_manager_test.exs
└── focus/
    ├── traversal_test.exs
    └── indicator_test.exs
```

### Core Types

```elixir
# Focus state
@type focus_state :: %{
  current: component_id | nil,
  stack: [component_id],
  groups: %{group_id => [component_id]},
  trapped_group: group_id | nil
}

# Tab order entry
@type tab_entry :: %{
  id: component_id,
  tab_index: integer() | nil,
  position: {x :: integer(), y :: integer()}
}

# Focus indicator
@type focus_indicator :: %{
  border_style: border_style(),
  fg: color(),
  bg: color()
}
```

### Dependencies

- Section 3.2 (Component lifecycle, Registry)
- Section 3.3 (Event routing, SpatialIndex)
- ComponentRegistry for component lookup

## Implementation Plan

### Task 3.4.1: Focus State

Implement focus state tracking and basic focus operations.

- [x] 3.4.1.1 Create `TermUI.FocusManager` GenServer
- [x] 3.4.1.2 Implement focus state with current and stack
- [x] 3.4.1.3 Implement `get_focused/0` returning current focus
- [x] 3.4.1.4 Implement `set_focused/1` with focus/blur events
- [x] 3.4.1.5 Implement focus history stack for push/pop

### Task 3.4.2: Focus Traversal

Implement Tab/Shift+Tab navigation between focusable components.

- [x] 3.4.2.1 Create `TermUI.Focus.Traversal` module
- [x] 3.4.2.2 Implement tab order calculation from positions
- [x] 3.4.2.3 Implement `focus_next/0` moving to next focusable
- [x] 3.4.2.4 Implement `focus_prev/0` moving to previous focusable
- [x] 3.4.2.5 Implement explicit `tab_index` support

### Task 3.4.3: Focus Properties

Implement component properties controlling focus behavior.

- [x] 3.4.3.1 Implement `focusable` property check
- [x] 3.4.3.2 Implement `disabled` property check
- [x] 3.4.3.3 Implement `auto_focus` on mount
- [x] 3.4.3.4 Implement `is_focused?/1` query function

### Task 3.4.4: Focus Trapping

Implement focus group and trapping for modals.

- [x] 3.4.4.1 Implement focus group registration
- [x] 3.4.4.2 Implement `trap_focus/1` for group
- [x] 3.4.4.3 Implement `release_focus/0` to exit trap
- [x] 3.4.4.4 Implement wrap-around within trapped group

### Task 3.4.5: Focus Indicators

Implement focus indicator styling.

- [x] 3.4.5.1 Create `TermUI.Focus.Indicator` module
- [x] 3.4.5.2 Implement default focus indicator style
- [x] 3.4.5.3 Implement focus state query for rendering
- [x] 3.4.5.4 Implement customizable indicator styles

### Unit Tests - Section 3.4

#### Focus State Tests
- [x] Test focus state tracks currently focused component
- [x] Test focus change emits blur to old and focus to new
- [x] Test focus stack push/pop operations
- [x] Test get_focused returns nil when no focus

#### Focus Traversal Tests
- [x] Test Tab moves to next focusable component
- [x] Test Shift+Tab moves to previous focusable
- [x] Test non-focusable components are skipped
- [x] Test disabled components are skipped
- [x] Test tab_index overrides position order

#### Focus Properties Tests
- [x] Test focusable check returns correct value
- [x] Test disabled prevents focus
- [x] Test auto_focus requests focus on mount
- [x] Test is_focused? returns correct state

#### Focus Trapping Tests
- [x] Test trap_focus restricts to group
- [x] Test traversal wraps within group
- [x] Test release_focus restores normal
- [x] Test nested trapping uses stack

## Success Criteria

1. **Focus state** correctly tracks focused component
2. **Focus events** sent on focus changes
3. **Tab traversal** navigates in correct order
4. **Focus trapping** restricts to group
5. **Properties** control focus behavior
6. **Indicators** provide visual feedback
7. All unit tests pass
8. Documentation complete

## Current Status

**Status**: Complete

### Summary
- All tasks completed
- 69 new tests added
- Total project tests: 1176
- All tests passing

### How to Run
```bash
mix test test/term_ui/focus_manager_test.exs
mix test test/term_ui/focus/traversal_test.exs
mix test test/term_ui/focus/indicator_test.exs
```

## Notes

### Design Considerations

- **Focus vs Selection** - Focus is input target, selection is chosen items
- **Modal stacking** - Multiple modals push/pop focus contexts
- **Default focus** - First focusable component gets focus on mount
- **Focus ring** - Visual indicator should be customizable

### Integration Points

- EventRouter receives focus updates for keyboard routing
- ComponentRegistry for component lookup and properties
- SpatialIndex for position-based tab order
- Components receive focus/blur events

### Future Considerations

- Directional focus navigation (arrow keys)
- Focus restoration on component remount
- Focus analytics for UX optimization
- Accessibility focus announcements
