# Feature: Section 6.12.1 ProcessMonitor Widget

## Problem Statement

Developers working with BEAM applications need visibility into running processes for debugging, performance analysis, and system monitoring. Current tools like Observer require a GUI, making them unsuitable for remote or terminal-only environments. A terminal-based process monitor widget leverages BEAM's excellent introspection capabilities to provide live process information directly in the TUI.

## Solution Overview

Implement a ProcessMonitor widget that:
- Displays live process information (PID, name, reductions, memory, message queue)
- Updates stats at configurable intervals
- Provides warnings for problematic processes (large queues, high memory)
- Shows process relationships (links, monitors)
- Displays stack traces for selected processes
- Supports process actions (kill, suspend, resume)
- Enables sorting and filtering

## Requirements (from Phase 6 Planning)

### 6.12.1 ProcessMonitor Widget

- [x] 6.12.1.1 Implement process list with PID, name, reductions, memory
- [x] 6.12.1.2 Implement live stats updates (configurable interval)
- [x] 6.12.1.3 Implement message queue depth display and warnings
- [x] 6.12.1.4 Implement process links/monitors visualization
- [x] 6.12.1.5 Implement stack trace display on selection
- [x] 6.12.1.6 Implement process actions (kill, suspend, resume)
- [x] 6.12.1.7 Implement sorting by reductions/memory/queue
- [x] 6.12.1.8 Implement process filtering by name/module

## Technical Design

### Process Info Structure

```elixir
@type process_info :: %{
  pid: pid(),
  registered_name: atom() | nil,
  initial_call: {module(), atom(), arity()} | nil,
  current_function: {module(), atom(), arity()} | nil,
  reductions: non_neg_integer(),
  memory: non_neg_integer(),
  message_queue_len: non_neg_integer(),
  status: atom(),
  links: [pid()],
  monitors: [term()],
  monitored_by: [pid()],
  stack_trace: [term()] | nil
}
```

### Sort Options

```elixir
@type sort_field :: :pid | :name | :reductions | :memory | :queue | :status
@type sort_direction :: :asc | :desc
```

### Warning Thresholds

```elixir
@type thresholds :: %{
  queue_warning: non_neg_integer(),    # Default: 1000
  queue_critical: non_neg_integer(),   # Default: 10000
  memory_warning: non_neg_integer(),   # Default: 50MB
  memory_critical: non_neg_integer()   # Default: 200MB
}
```

### Keyboard Controls

| Key | Action |
|-----|--------|
| Up/Down | Move selection |
| PageUp/PageDown | Scroll by page |
| Enter | Show process details |
| r | Refresh now |
| s | Cycle sort field |
| S | Toggle sort direction |
| / | Start filter input |
| k | Kill selected process |
| p | Pause/resume selected process |
| l | Show links/monitors |
| t | Show stack trace |
| Escape | Clear filter/close details |

## Implementation Plan

### Step 1: Core Structure (6.12.1.1)
- [x] Create `lib/term_ui/widgets/process_monitor.ex`
- [x] Define types and process info structure
- [x] Implement `new/1` for props creation
- [x] Implement `init/1` for state initialization
- [x] Implement process list fetching using `Process.list/0` and `Process.info/2`

### Step 2: Live Updates (6.12.1.2)
- [x] Implement refresh timer using `handle_info`
- [x] Configurable update interval (default: 1000ms)
- [x] Manual refresh with 'r' key

### Step 3: Message Queue Display (6.12.1.3)
- [x] Display queue length in process list
- [x] Color-code by threshold (normal/warning/critical)
- [x] Show queue warning indicator
- [x] Configurable thresholds

### Step 4: Links/Monitors Visualization (6.12.1.4)
- [x] Fetch links and monitors from process info
- [x] Display in detail panel
- [x] Show monitored_by relationships
- [x] Toggle with 'l' key

### Step 5: Stack Trace Display (6.12.1.5)
- [x] Fetch stack trace using `Process.info(pid, :current_stacktrace)`
- [x] Display in detail panel
- [x] Format module:function/arity
- [x] Toggle with 't' key

### Step 6: Process Actions (6.12.1.6)
- [x] Implement kill with confirmation
- [x] Implement suspend (`:erlang.suspend_process/1`)
- [x] Implement resume (`:erlang.resume_process/1`)
- [x] Show action result feedback
- [x] Confirmation dialog (y/n)

### Step 7: Sorting (6.12.1.7)
- [x] Sort by PID
- [x] Sort by name
- [x] Sort by reductions (default)
- [x] Sort by memory
- [x] Sort by queue length
- [x] Sort by status
- [x] Toggle direction with 'S'

### Step 8: Filtering (6.12.1.8)
- [x] Filter by registered name
- [x] Filter by module (initial_call)
- [x] Regex support
- [x] Clear filter with Escape

### Step 9: Public API
- [x] `refresh/1` - Force refresh
- [x] `set_interval/2` - Change update interval
- [x] `set_sort/3` - Set sort field and direction
- [x] `set_filter/2` - Set filter pattern
- [x] `get_selected/1` - Get selected process info
- [x] `process_count/1` - Get process count
- [x] `get_stack_trace/1` - Get stack trace for a PID

### Step 10: Tests
- [x] Test process list retrieval
- [x] Test sorting by each field
- [x] Test filtering
- [x] Test warning thresholds
- [x] Test process actions (on test processes)
- [x] Test live updates
- [x] Test keyboard controls
- [x] Test callbacks

### Step 11: Example Application
- [x] Create `examples/process_monitor/` directory
- [x] Show live process monitoring
- [x] Demonstrate sorting and filtering
- [x] Show process details view
- [x] Spawn test workers

## Success Criteria

- [x] ProcessMonitor displays live process list
- [x] Updates refresh at configured interval
- [x] Sorting works for all fields
- [x] Filtering narrows process list
- [x] Warning thresholds highlight problematic processes
- [x] Process actions work correctly
- [x] All tests pass (44 tests)
- [x] Example application demonstrates features

## Current Status

**Status**: COMPLETED

**What Works**:
- ProcessMonitor widget fully implemented
- All 8 requirements from Phase 6 planning met
- 44 comprehensive tests passing
- Example application with test worker spawning

**Files Created**:
- `lib/term_ui/widgets/process_monitor.ex` (~850 lines)
- `test/term_ui/widgets/process_monitor_test.exs` (44 tests)
- `examples/process_monitor/` (example application)
- `notes/features/6.12.1-processmonitor-widget.md` (this document)
- `notes/summaries/6.12.1-processmonitor-widget-summary.md`

**Test Coverage**:
- 44 tests covering all features
- Props and initialization
- Navigation (up/down/page/home/end)
- Sorting (all 6 fields, direction toggle)
- Filtering (input, apply, clear, regex)
- Details panel (info, links, trace modes)
- Process actions (kill, suspend with confirmation)
- Refresh and timer
- Public API functions
- Callbacks (on_select, on_action)
- Rendering
