# Feature: Task 2.3.3 - Implement Cursor Position Optimization

**Branch:** `feature/2.3.3-cursor-optimization`
**Base:** `multi-renderer`
**Date:** 2025-12-05

## Overview

Integrate the existing `TermUI.Renderer.CursorOptimizer` module into the Raw backend's `move_cursor/2` function. This optimization reduces cursor movement bytes by 40%+ by choosing the cheapest movement option.

## Reference

See `notes/planning/multi-renderer/phase-02-raw-backend.md` Section 2.3.3.

## Existing Infrastructure

The `TermUI.Renderer.CursorOptimizer` module already provides:
- `optimal_move/4` - Finds optimal movement from current to target position
- Cost calculation for absolute, relative, CR, newline, home, and space options
- Returns `{sequence, cost}` where sequence is iodata

## Tasks

### Implementation

- [ ] 2.3.3.1 Calculate cost of absolute move (`\e[row;colH` = 6-10 bytes)
- [ ] 2.3.3.2 Calculate cost of relative moves (up/down/forward/back sequences)
- [ ] 2.3.3.3 Choose cheaper option based on distance and current position
- [ ] 2.3.3.4 Reference existing `TermUI.Renderer.CursorOptimizer` for algorithm

### Approach

Since `CursorOptimizer` already exists, I'll:
1. Add `:optimize_cursor` option to Raw backend (default: `true`)
2. Modify `move_cursor/2` to use `CursorOptimizer.optimal_move/4` when optimization enabled
3. Fall back to absolute positioning when optimization disabled

### Unit Tests

- [ ] Test cursor optimizer chooses relative move for short horizontal distances
- [ ] Test cursor optimizer chooses relative move for short vertical distances
- [ ] Test optimizer uses absolute positioning for large distances
- [ ] Test `:optimize_cursor` option controls behavior

## Files to Modify

- `lib/term_ui/backend/raw.ex` - Integrate CursorOptimizer into `move_cursor/2`
- `test/term_ui/backend/raw_test.exs` - Add optimization tests

## Design Notes

### Option: optimize_cursor

Add `:optimize_cursor` option to `init/1`:
- Default: `true` (optimize by default)
- When `true`: Use `CursorOptimizer.optimal_move/4`
- When `false`: Use absolute positioning only

This allows disabling optimization for debugging or when predictable output is needed.

### Implementation Pattern

```elixir
def move_cursor(%__MODULE__{optimize_cursor: true} = state, {row, col}) do
  {sequence, _cost} = CursorOptimizer.optimal_move(
    current_row, current_col, row, col
  )
  write_to_terminal(sequence)
  {:ok, %{state | cursor_position: {row, col}}}
end
```

## Verification

1. `mix compile` - no warnings
2. `mix test test/term_ui/backend/raw_test.exs` - all tests pass
3. `mix format --check-formatted` - code formatted
