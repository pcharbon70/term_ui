# Feature: Section 6.11.1 LogViewer Widget

## Problem Statement

Applications need to display real-time logs with the ability to handle millions of lines efficiently. Current log viewing solutions in terminal UIs often struggle with large datasets, lack search capabilities, and don't provide adequate filtering. A dedicated LogViewer widget is needed for monitoring applications, debugging, and log analysis.

## Solution Overview

Implement a LogViewer widget that displays logs with:
- Virtual scrolling for efficient rendering of large datasets
- Tail mode for live log monitoring
- Search with regex support and match highlighting
- Syntax highlighting for log levels and timestamps
- Filtering by level, source, or pattern
- Line bookmarking
- Selection and copy functionality
- Wrap/truncate toggle for long lines

## Requirements (from Phase 6 Planning)

### 6.11.1 LogViewer Widget

- [x] 6.11.1.1 Implement virtual scrolling for millions of lines
- [x] 6.11.1.2 Implement tail mode (auto-scroll to bottom)
- [x] 6.11.1.3 Implement search with regex support and highlighting
- [x] 6.11.1.4 Implement syntax highlighting (log levels, timestamps)
- [x] 6.11.1.5 Implement filter by level/source/pattern
- [x] 6.11.1.6 Implement line bookmarking
- [x] 6.11.1.7 Implement selection and copy to clipboard
- [x] 6.11.1.8 Implement wrap/truncate toggle for long lines

## Technical Design

### Log Entry Structure

```elixir
@type log_level :: :debug | :info | :notice | :warning | :error | :critical | :alert | :emergency

@type log_entry :: %{
  id: non_neg_integer(),        # Unique line number
  timestamp: DateTime.t() | nil, # Parsed timestamp
  level: log_level() | nil,     # Parsed log level
  source: String.t() | nil,     # Source/module name
  message: String.t(),          # Log message
  raw: String.t()               # Original raw line
}
```

### Keyboard Controls

| Key | Action |
|-----|--------|
| Up/Down | Move cursor |
| PageUp/PageDown | Scroll by page |
| Home/End | Jump to first/last line |
| / | Start search |
| n/N | Next/previous search match |
| f | Toggle filter mode |
| b | Toggle bookmark on current line |
| B | Jump to next bookmark |
| t | Toggle tail mode |
| w | Toggle wrap mode |
| Space | Start/extend selection |
| Escape | Clear search/filter/selection |

## Implementation Plan

### Step 1: Core Structure (6.11.1.1)
- [x] Create `lib/term_ui/widgets/log_viewer.ex`
- [x] Define types and log entry structure
- [x] Implement `new/1` for props creation
- [x] Implement `init/1` for state initialization
- [x] Implement basic line storage

### Step 2: Virtual Scrolling (6.11.1.1)
- [x] Implement visible range calculation
- [x] Implement scroll offset tracking
- [x] Implement efficient rendering of visible lines only
- [x] Implement PageUp/PageDown/Home/End navigation

### Step 3: Tail Mode (6.11.1.2)
- [x] Implement tail mode state
- [x] Auto-scroll to bottom on new lines
- [x] Disable tail mode on manual scroll up
- [x] Toggle with 't' key
- [x] Show tail mode indicator

### Step 4: Search (6.11.1.3)
- [x] Implement search state
- [x] Implement '/' to start search
- [x] Implement regex pattern matching
- [x] Implement match navigation (n/N)
- [x] Implement match highlighting
- [x] Show match count

### Step 5: Syntax Highlighting (6.11.1.4)
- [x] Implement log parser
- [x] Implement timestamp detection
- [x] Implement level detection and coloring
- [x] Implement source highlighting
- [x] Support custom parsers

### Step 6: Filtering (6.11.1.5)
- [x] Implement filter state
- [x] Implement level filtering
- [x] Implement source pattern filtering
- [x] Implement message pattern filtering
- [x] Implement filter UI ('f' key)
- [x] Show filter indicator and count

### Step 7: Bookmarking (6.11.1.6)
- [x] Implement bookmark MapSet
- [x] Implement 'b' to toggle bookmark
- [x] Implement 'B' to jump to next bookmark
- [x] Render bookmark indicators
- [x] Filter to bookmarks only option

### Step 8: Selection & Copy (6.11.1.7)
- [x] Implement selection range
- [x] Implement Space to start/extend selection
- [x] Implement 'y' to copy (via callback)
- [x] Highlight selected lines
- [x] Get selected text API

### Step 9: Wrap/Truncate (6.11.1.8)
- [x] Implement wrap mode state
- [x] Implement line truncation with ellipsis
- [x] Toggle with 'w' key

### Step 10: Public API
- [x] `add_line/2` - Add single log line
- [x] `add_lines/2` - Add multiple lines
- [x] `clear/1` - Clear all lines
- [x] `get_selected_text/1` - Get selection
- [x] `set_filter/2` - Set filter
- [x] `clear_filter/1` - Clear filter
- [x] `search/2` - Start search
- [x] `goto_line/2` - Jump to line
- [x] `get_bookmarks/1` - Get bookmarked lines

### Step 11: Tests
- [x] Test virtual scrolling renders correct range
- [x] Test tail mode auto-scrolls
- [x] Test search finds and highlights matches
- [x] Test level detection and coloring
- [x] Test filtering reduces visible lines
- [x] Test bookmarking persistence
- [x] Test selection and copy
- [x] Test wrap/truncate modes

### Step 12: Example Application
- [x] Create `examples/log_viewer/` directory
- [x] Implement log generator demo
- [x] Show filtering and search
- [x] Demonstrate all features

## Success Criteria

- [x] LogViewer renders log lines efficiently
- [x] Virtual scrolling handles large datasets
- [x] Tail mode follows new log entries
- [x] Search finds matches with regex support
- [x] Log levels are color-coded
- [x] Filters reduce visible lines correctly
- [x] Bookmarks can be toggled and navigated
- [x] Selection works for copy operations
- [x] Wrap/truncate modes work correctly
- [x] All tests pass (66 tests)
- [x] Example application demonstrates features

## Current Status

**Status**: COMPLETED

**What Works**:
- LogViewer widget fully implemented
- All 8 requirements from Phase 6 planning met
- 66 comprehensive tests passing
- Example application demonstrating log monitoring

**Files Created**:
- `lib/term_ui/widgets/log_viewer.ex` (~970 lines)
- `test/term_ui/widgets/log_viewer_test.exs` (66 tests)
- `examples/log_viewer/` (example application)
- `notes/summaries/6.11.1-logviewer-widget-summary.md`

**Test Coverage**:
- 66 tests covering all features
- Props and initialization
- Level and source detection
- Navigation (cursor, page, home/end)
- Search with regex
- Filtering by level/pattern
- Bookmarking
- Tail mode
- Wrap mode
- Selection
- Public API functions
- Edge cases
