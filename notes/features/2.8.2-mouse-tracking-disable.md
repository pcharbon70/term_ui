# Feature: Task 2.8.2 - Implement Mouse Tracking Disable

**Branch:** `feature/2.8.2-mouse-tracking-disable`
**Base:** `multi-renderer`
**Date:** 2025-12-05
**Status:** In Progress

## Overview

Implement `disable_mouse/1` function for the Raw backend to disable mouse tracking.

## Requirements

From phase plan:
- 2.8.2.1 Implement `disable_mouse/1` accepting state
- 2.8.2.2 Disable SGR mode with `\e[?1006l`
- 2.8.2.3 Disable tracking mode with appropriate sequence (`\e[?1003l`, `\e[?1002l`, or `\e[?9l`)
- 2.8.2.4 Update `mouse_mode` to `:none` in state

## Technical Analysis

### Existing Infrastructure

The shutdown/1 function already uses a defensive mouse disable sequence:
```elixir
@all_mouse_off "\e[?1006l\e[?1003l\e[?1002l\e[?1000l"
```

For `disable_mouse/1`, we can either:
1. Use the same defensive approach (disable all modes)
2. Only disable the specific mode that was enabled

Option 1 is safer and simpler - it ensures clean state regardless of what mode was active.

### ANSI Module Functions

- `ANSI.disable_mouse_tracking(:normal)` → `\e[?1000l`
- `ANSI.disable_mouse_tracking(:button)` → `\e[?1002l`
- `ANSI.disable_mouse_tracking(:all)` → `\e[?1003l`
- `ANSI.disable_sgr_mouse()` → `\e[?1006l`

## Implementation Plan

### 1. Implement `disable_mouse/1`

```elixir
@doc """
Disables mouse tracking.

## Returns

- `{:ok, updated_state}` with `mouse_mode` set to `:none`
"""
@spec disable_mouse(t()) :: {:ok, t()}
def disable_mouse(%__MODULE__{mouse_mode: :none} = state) do
  # Already disabled - idempotent no-op
  {:ok, state}
end

def disable_mouse(state) do
  # Disable SGR mode first
  write_to_terminal(ANSI.disable_sgr_mouse())

  # Disable the current tracking mode
  ansi_mode = mouse_mode_to_ansi(state.mouse_mode)
  if ansi_mode do
    write_to_terminal(ANSI.disable_mouse_tracking(ansi_mode))
  end

  {:ok, %{state | mouse_mode: :none}}
end
```

### 2. Add Tests

Tests to add:
- `disable_mouse/1` disables tracking and updates state
- `disable_mouse/1` is idempotent (already disabled → no change)
- `disable_mouse/1` works after enabling each mode
- `disable_mouse/1` has documentation

## Files to Modify

| File | Changes |
|------|---------|
| `lib/term_ui/backend/raw.ex` | Add `disable_mouse/1` function |
| `test/term_ui/backend/raw_test.exs` | Add tests for `disable_mouse/1` |
| `notes/planning/multi-renderer/phase-02-raw-backend.md` | Mark task complete |

## Verification

1. `mix compile` - no warnings
2. `mix test test/term_ui/backend/raw_test.exs` - all tests pass
3. `mix format --check-formatted` - properly formatted
