# Feature Plan: Section 7.3 - Terminal Resize Handling

## Problem Statement

When users resize their terminal window, TermUI applications must adapt to the new dimensions. Currently:
- Terminal has resize callback registration (sends `{:terminal_resize, {rows, cols}}`)
- BufferManager has `resize/3` function
- But Runtime doesn't register for resize notifications or handle them

**Impact:** Without resize handling:
- Display becomes corrupted or truncated when terminal size changes
- Applications don't fill the new available space
- User experience is poor when switching window sizes

## Solution Overview

Complete the resize handling pipeline:

```
Terminal (SIGWINCH) → resize callbacks → Runtime → update dimensions → resize buffers → re-render
```

### Key Design Decisions

1. **Register Runtime for resize callbacks** - Runtime receives `{:terminal_resize, ...}` messages
2. **Update BufferManager dimensions** - Call existing `BufferManager.resize/3`
3. **Broadcast Event.Resize** - Notify all components of new dimensions
4. **Force immediate re-render** - Clear screen and redraw at new size

### Architecture

```
┌──────────┐     ┌─────────┐     ┌───────────────┐     ┌────────────┐
│ Terminal │ ──> │ Runtime │ ──> │ BufferManager │ ──> │ Components │
│ SIGWINCH │     │ handle  │     │ resize        │     │ Event.     │
│          │     │ _info   │     │               │     │ Resize     │
└──────────┘     └─────────┘     └───────────────┘     └────────────┘
```

## Technical Details

### File Structure

```
lib/term_ui/
├── runtime.ex              # Add resize handling
└── renderer/
    └── buffer_manager.ex   # Already has resize/3
```

### Dependencies

- `TermUI.Terminal.register_resize_callback/1` - Already exists
- `TermUI.Terminal.unregister_resize_callback/1` - Already exists
- `TermUI.Renderer.BufferManager.resize/3` - Already exists
- `TermUI.Event.Resize` - Already exists

### Existing Infrastructure

The Terminal already handles SIGWINCH and sends `{:terminal_resize, {rows, cols}}` to registered callbacks (line 365-366 in terminal.ex).

## Implementation Plan

### Task 7.3.1: Resize Signal Detection ✅

- [x] 7.3.1.1 Register Runtime with Terminal for resize callbacks in init
- [x] 7.3.1.2 Unregister Runtime in terminate
- [x] 7.3.1.3 Verify Terminal SIGWINCH handler works (already implemented)

### Task 7.3.2: Buffer Recreation ✅

- [x] 7.3.2.1 Add handle_info for `{:terminal_resize, {rows, cols}}` in Runtime
- [x] 7.3.2.2 Call BufferManager.resize with new dimensions
- [x] 7.3.2.3 Update Runtime.State.dimensions with new size
- [x] 7.3.2.4 Clear both buffers to force full redraw

### Task 7.3.3: Re-render Trigger ✅

- [x] 7.3.3.1 Mark state as dirty after resize
- [x] 7.3.3.2 Create Event.Resize with new dimensions
- [x] 7.3.3.3 Broadcast Event.Resize to all components
- [x] 7.3.3.4 Force immediate render (call do_render directly)
- [x] 7.3.3.5 Clear screen before re-render to avoid artifacts

### Unit Tests ✅

- [x] Test Runtime registers for resize callbacks on init
- [x] Test Runtime unregisters on terminate
- [x] Test resize event updates Runtime dimensions
- [x] Test resize calls BufferManager.resize
- [x] Test resize marks state dirty
- [x] Test resize broadcasts Event.Resize to components
- [x] Test rapid resize events are handled correctly

## Success Criteria

1. Runtime registers with Terminal for resize callbacks
2. Resize events update Runtime.State.dimensions
3. BufferManager.resize is called with new dimensions
4. Event.Resize is broadcast to all components
5. Screen re-renders immediately after resize
6. All existing tests continue to pass
7. New unit tests pass

## Current Status

- **Planning**: Complete
- **Implementation**: Complete
- **Tests**: Complete (5 tests passing)

## Notes/Considerations

- Clear screen (ESC[2J) before re-render prevents artifacts from old size
- Force immediate render rather than waiting for next tick improves UX
- Components may recalculate layouts in response to Event.Resize
- Multiple rapid resizes should be handled gracefully (latest wins)
